<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å®‰å…¨éšæ‚£ä¸¾æŠ¥ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            overscroll-behavior: contain;
        }
        
        .view { 
            display: none; 
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .view.active { 
            display: block; 
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 1.5rem;
            bottom: -1.5rem;
            width: 2px;
            background: linear-gradient(to bottom, #3b82f6, #10b981);
        }
        
        .timeline-item:last-child::before {
            display: none;
        }
        
        .timeline-dot {
            position: absolute;
            left: calc(1rem - 0.5rem + 1px);
            top: 1.5rem;
            width: 1rem;
            height: 1rem;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .safety-level-high { border-left: 4px solid #ef4444; }
        .safety-level-medium { border-left: 4px solid #f59e0b; }
        .safety-level-low { border-left: 4px solid #10b981; }
        
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            transform: scale(1.1);
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            margin: 20px 0;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 100;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <div id="app-container" class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative">

        <!-- é€šçŸ¥æç¤º -->
        <div id="notification-container"></div>

        <!-- è§†å›¾ 1: é¦–é¡µ - æ ‡æ®µé€‰æ‹© -->
        <div id="login-view" class="view p-6">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4">
                    <i class="fas fa-shield-alt text-white text-3xl"></i>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2 break-words px-4">æ™ºæ…§å®‰å…¨éšæ‚£ä¸¾æŠ¥ç³»ç»Ÿ</h1>
                <p class="text-gray-600 text-sm">320å›½é“ä½™æ­ä¸­æ³°æ®µå·¥ç¨‹é¡¹ç›®</p>
            </div>

            <div class="space-y-4">
                <!-- ç¬¬TJ01æ ‡æ®µ -->
                <button onclick="selectSection('TJ01')" class="w-full bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-6 text-white transition-all duration-300 hover:shadow-xl hover:scale-105 flex flex-col items-center justify-center">
                    <i class="fas fa-road text-4xl mb-3"></i>
                    <span class="font-bold text-xl">ç¬¬TJ01æ ‡æ®µ</span>
                    <span class="text-sm opacity-90 mt-1">ç‚¹å‡»è¿›å…¥</span>
                </button>

                <!-- ç¬¬TJ02æ ‡æ®µ -->
                <button onclick="selectSection('TJ02')" class="w-full bg-gradient-to-br from-green-500 to-teal-600 rounded-2xl p-6 text-white transition-all duration-300 hover:shadow-xl hover:scale-105 flex flex-col items-center justify-center">
                    <i class="fas fa-road text-4xl mb-3"></i>
                    <span class="font-bold text-xl">ç¬¬TJ02æ ‡æ®µ</span>
                    <span class="text-sm opacity-90 mt-1">ç‚¹å‡»è¿›å…¥</span>
                </button>
            </div>

          </div>

        <!-- è§†å›¾ 2: æ ‡æ®µè§’è‰²é€‰æ‹© -->
        <div id="section-view" class="view p-6">
            <div class="text-center mb-8">
                <button onclick="showView('login-view')" class="mb-4 p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i>è¿”å›æ ‡æ®µé€‰æ‹©
                </button>
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-3">
                    <i class="fas fa-road text-white text-2xl"></i>
                </div>
                <h1 class="text-lg sm:text-xl font-bold text-gray-800 mb-1 break-words px-4" id="section-title">ç¬¬TJ01æ ‡æ®µ</h1>
                <p class="text-gray-600 text-sm">è¯·é€‰æ‹©æ‚¨çš„èº«ä»½</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- æˆ‘è¦ä¸¾æŠ¥ -->
                <button onclick="directToReport()" class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-6 text-white transition-all duration-300 hover:shadow-xl hover:scale-105 flex flex-col items-center justify-center">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <span class="font-bold text-lg">æˆ‘è¦ä¸¾æŠ¥</span>
                </button>

                <!-- å®‰å…¨çŸ¥è¯† -->
                <button onclick="showSafetyKnowledge()" class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white transition-all duration-300 hover:shadow-xl hover:scale-105 flex flex-col items-center justify-center">
                    <i class="fas fa-book-open text-4xl mb-3"></i>
                    <span class="font-bold text-lg">å®‰å…¨çŸ¥è¯†</span>
                </button>

                <!-- ä¸ªäººä¸­å¿ƒ -->
                <button onclick="loginAs('employee')" class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white transition-all duration-300 hover:shadow-xl hover:scale-105 flex flex-col items-center justify-center">
                    <i class="fas fa-user text-4xl mb-3"></i>
                    <span class="font-bold text-lg">ä¸ªäººä¸­å¿ƒ</span>
                </button>

                <!-- å®‰å…¨ç¯ä¿éƒ¨ -->
                <button onclick="loginAs('manager')" class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white transition-all duration-300 hover:shadow-xl hover:scale-105 flex flex-col items-center justify-center">
                    <i class="fas fa-user-shield text-4xl mb-3"></i>
                    <span class="font-bold text-lg">å®‰å…¨ç¯ä¿éƒ¨</span>
                </button>
            </div>

          </div>

        <!-- å®‰å…¨çŸ¥è¯†å¼¹çª— -->
        <div id="safety-knowledge-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-y-auto slide-up">
                <div class="sticky top-0 bg-gradient-to-r from-green-600 to-teal-600 text-white p-6 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">å®‰å…¨çŸ¥è¯†</h2>
                        <button onclick="closeSafetyKnowledge()" class="text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6 space-y-4 text-gray-700">
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-bold text-green-800 mb-3">
                            <i class="fas fa-book-open mr-2"></i>å®‰å…¨ç”Ÿäº§çŸ¥è¯†åº“
                        </h3>
                        <p class="text-sm leading-relaxed text-gray-700">æ¬¢è¿è®¿é—®320å›½é“ä½™æ­ååè‡³å¯Œé˜³é«˜æ¡¥æ®µå·¥ç¨‹é¡¹ç›®å®‰å…¨çŸ¥è¯†åº“ï¼Œè¿™é‡Œæœ‰ä¸°å¯Œçš„å®‰å…¨å­¦ä¹ èµ„æ–™ä¾›æ‚¨å­¦ä¹ ã€‚</p>
                    </div>

                    <!-- å®‰å…¨çŸ¥è¯†åˆ†ç±» -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center cursor-pointer hover:bg-red-100 transition" onclick="showKnowledgeCategory('fire')">
                            <i class="fas fa-fire text-red-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-red-700">æ¶ˆé˜²å®‰å…¨</p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center cursor-pointer hover:bg-yellow-100 transition" onclick="showKnowledgeCategory('electric')">
                            <i class="fas fa-bolt text-yellow-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-yellow-700">ç”¨ç”µå®‰å…¨</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center cursor-pointer hover:bg-blue-100 transition" onclick="showKnowledgeCategory('mechanical')">
                            <i class="fas fa-cogs text-blue-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-blue-700">è®¾å¤‡å®‰å…¨</p>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center cursor-pointer hover:bg-orange-100 transition" onclick="showKnowledgeCategory('height')">
                            <i class="fas fa-mountain text-orange-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-orange-700">é«˜å¤„ä½œä¸š</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center cursor-pointer hover:bg-purple-100 transition" onclick="showKnowledgeCategory('edge')">
                            <i class="fas fa-ruler-vertical text-purple-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-purple-700">ä¸´è¾¹é˜²æŠ¤</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center cursor-pointer hover:bg-green-100 transition" onclick="showKnowledgeCategory('environment')">
                            <i class="fas fa-leaf text-green-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-green-700">ç¯å¢ƒä¿æŠ¤</p>
                        </div>
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 text-center cursor-pointer hover:bg-indigo-100 transition" onclick="showKnowledgeCategory('ppe')">
                            <i class="fas fa-hard-hat text-indigo-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-indigo-700">é˜²æŠ¤è£…å¤‡</p>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:bg-gray-100 transition" onclick="showKnowledgeCategory('other')">
                            <i class="fas fa-ellipsis-h text-gray-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium text-gray-700">å…¶ä»–å®‰å…¨</p>
                        </div>
                    </div>

                    <!-- ç®¡ç†å‘˜ä¸Šä¼ åŒºåŸŸï¼ˆä»…å®‰å…¨ç¯ä¿éƒ¨å¯è§ï¼‰ -->
                    <div id="admin-upload-area" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-bold text-blue-800 mb-3">
                            <i class="fas fa-upload mr-2"></i>ä¸Šä¼ å®‰å…¨èµ„æ–™
                        </h3>
                        <div class="space-y-3">
                            <input type="text" id="knowledge-title" class="w-full p-2 border border-blue-300 rounded-lg text-sm" placeholder="èµ„æ–™æ ‡é¢˜">
                            <textarea id="knowledge-content" class="w-full p-2 border border-blue-300 rounded-lg text-sm" rows="3" placeholder="èµ„æ–™å†…å®¹æè¿°"></textarea>
                            <input type="file" id="knowledge-file" class="w-full p-2 border border-blue-300 rounded-lg text-sm" accept=".pdf,.doc,.docx,.ppt,.pptx">
                            <button onclick="uploadKnowledge()" class="w-full bg-blue-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-upload mr-2"></i>ä¸Šä¼ èµ„æ–™
                            </button>
                        </div>
                    </div>

                    <!-- å·²ä¸Šä¼ æ–‡æ¡£ç®¡ç†åŒºåŸŸï¼ˆä»…å®‰å…¨ç¯ä¿éƒ¨å¯è§ï¼‰ -->
                    <div id="document-management-area" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="font-bold text-yellow-800 mb-3">
                            <i class="fas fa-folder-open mr-2"></i>å·²ä¸Šä¼ æ–‡æ¡£ç®¡ç†
                        </h3>
                        <div id="uploaded-documents-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- æ–‡æ¡£åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- çŸ¥è¯†å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="knowledge-content-area" class="hidden bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-file-alt mr-2"></i><span id="knowledge-title-display"></span>
                        </h3>
                        <div id="knowledge-content-display" class="text-sm text-gray-700 space-y-3"></div>
                    </div>
                </div>

                <div class="p-6 pt-0">
                    <button onclick="closeSafetyKnowledge()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl hover:bg-green-600 transition">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- é€šç”¨å¤´éƒ¨ -->
        <div id="app-header" class="hidden bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 sticky top-0 z-50 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="back-button" onclick="goBack()" class="mr-3 p-2 hover:bg-white/20 rounded-lg transition">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h1 id="header-title" class="text-lg font-bold"></h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="showNotifications()" class="relative p-2 hover:bg-white/20 rounded-lg transition">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    <button onclick="logout()" class="p-2 hover:bg-white/20 rounded-lg transition">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div id="bottom-nav" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
            <div class="max-w-md mx-auto flex justify-around items-center py-2">
                <button onclick="showView('main-view')" class="nav-item flex flex-col items-center p-2 text-blue-600 transition">
                    <i class="fas fa-home text-xl mb-1"></i>
                    <span class="text-xs">é¦–é¡µ</span>
                </button>
                <button onclick="showView('stats-view')" class="nav-item flex flex-col items-center p-2 text-gray-600 hover:text-blue-600 transition">
                    <i class="fas fa-chart-bar text-xl mb-1"></i>
                    <span class="text-xs">ç»Ÿè®¡</span>
                </button>
                <button onclick="showView('my-reports-view')" class="nav-item flex flex-col items-center p-2 text-gray-600 hover:text-blue-600 transition">
                    <i class="fas fa-list-alt text-xl mb-1"></i>
                    <span class="text-xs">æˆ‘çš„</span>
                </button>
            </div>
        </div>

        <!-- ä¸¾æŠ¥é¡»çŸ¥å¼¹çª— -->
        <div id="report-notice-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full slide-up">
                <div class="bg-gradient-to-r from-red-600 to-orange-600 text-white p-6 rounded-t-2xl">
                    <h2 class="text-xl font-bold text-center">ä¸¾æŠ¥é¡»çŸ¥</h2>
                </div>
                <div class="p-6 text-gray-700">
                    <div class="space-y-3 text-sm">
                        <p class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            è¯·ç¡®ä¿ä¸¾æŠ¥å†…å®¹çœŸå®ã€å‡†ç¡®
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            æä¾›è¯¦ç»†çš„éšæ‚£ä½ç½®å’Œæè¿°
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            å¦‚æœ‰ç°åœºç…§ç‰‡è¯·ä¸€å¹¶ä¸Šä¼ 
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mr-2 mt-1"></i>
                            æ¶æ„ä¸¾æŠ¥å°†æ‰¿æ‹…ç›¸åº”è´£ä»»
                        </p>
                    </div>
                    <div class="mt-6 text-center">
                        <div id="countdown-timer" class="text-lg font-semibold text-gray-600 mb-4"></div>
                        <button id="confirm-report-btn" onclick="confirmReportAndProceed()" disabled class="w-full bg-gray-300 text-gray-500 font-bold py-3 px-6 rounded-xl cursor-not-allowed transition">
                            è¯·é˜…è¯»å®Œæ¯• (5ç§’)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§†å›¾ 2: ä¸»ç•Œé¢ -->
        <div id="main-view" class="view p-4 pb-20">
            <!-- å‘˜å·¥ç•Œé¢ -->
            <div id="employee-dashboard">
                <!-- å¿«é€Ÿä¸¾æŠ¥æŒ‰é’® -->
                <button onclick="showView('new-report-view')" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-xl mb-6 text-lg shadow-lg flex items-center justify-center">
                    <i class="fas fa-camera mr-3 text-xl"></i>
                    ä¸ŠæŠ¥å®‰å…¨éšæ‚£
                </button>
                
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-3 text-white text-center">
                        <div class="text-2xl font-bold" id="home-pending-count">0</div>
                        <div class="text-xs opacity-90">å·²æäº¤</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-3 text-white text-center">
                        <div class="text-2xl font-bold" id="home-processing-count">0</div>
                        <div class="text-xs opacity-90">å¤„ç†ä¸­</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-xl p-3 text-white text-center">
                        <div class="text-2xl font-bold" id="home-closed-count">0</div>
                        <div class="text-xs opacity-90">å·²åŠç»“</div>
                    </div>
                </div>
                
                <!-- æœ€è¿‘ä¸¾æŠ¥ -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">æœ€è¿‘ä¸¾æŠ¥</h3>
                    <div id="reports-list" class="space-y-3"></div>
                </div>
            </div>
            
            <!-- å®‰å…¨ç¯ä¿éƒ¨ç•Œé¢ -->
            <div id="manager-dashboard">
                <!-- çŠ¶æ€æ ‡ç­¾å¡ç‰‡ï¼ˆå¯ç‚¹å‡»åˆ‡æ¢ï¼‰ -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="filterManagerReports('pending')" class="manager-filter-card bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-4 text-white text-center transition-all duration-300 hover:shadow-lg active:scale-95 border-4 border-white shadow-xl scale-105">
                        <div class="text-2xl font-bold" id="manager-pending-count">0</div>
                        <div class="text-xs opacity-90 mt-1">å¾…å¤„ç†</div>
                    </button>
                    <button onclick="filterManagerReports('processing')" class="manager-filter-card bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-4 text-white text-center transition-all duration-300 hover:shadow-lg active:scale-95 border-4 border-transparent">
                        <div class="text-2xl font-bold" id="manager-processing-count">0</div>
                        <div class="text-xs opacity-90 mt-1">å¤„ç†ä¸­</div>
                    </button>
                    <button onclick="filterManagerReports('closed')" class="manager-filter-card bg-gradient-to-br from-green-400 to-green-600 rounded-xl p-4 text-white text-center transition-all duration-300 hover:shadow-lg active:scale-95 border-4 border-transparent">
                        <div class="text-2xl font-bold" id="manager-closed-count">0</div>
                        <div class="text-xs opacity-90 mt-1">å·²åŠç»“</div>
                    </button>
                </div>

                <!-- ä¸¾æŠ¥åˆ—è¡¨ -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-800" id="manager-list-title">å¾…å¤„ç†ä¸¾æŠ¥</h3>
                    <div id="manager-reports-list" class="space-y-3"></div>
                </div>
            </div>
            
        </div>

        <!-- è§†å›¾ 3: æ–°å»ºä¸¾æŠ¥é¡µ -->
        <div id="new-report-view" class="view p-4 pb-20">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ä¸ŠæŠ¥å®‰å…¨éšæ‚£</h2>
            
            <form id="report-form" class="space-y-4">
                <!-- éšæ‚£ç±»å‹ -->
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <label class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>éšæ‚£ç±»å‹
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="fire" class="peer hidden" checked>
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-red-500 peer-checked:bg-red-50 transition">
                                <i class="fas fa-fire text-red-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">æ¶ˆé˜²éšæ‚£</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="electric" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition">
                                <i class="fas fa-bolt text-yellow-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">ç”¨ç”µéšæ‚£</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="mechanical" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 transition">
                                <i class="fas fa-cogs text-blue-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">è®¾å¤‡éšæ‚£</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="height" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
                                <i class="fas fa-mountain text-orange-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">é«˜å¤„ä½œä¸š</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="edge" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-purple-500 peer-checked:bg-purple-50 transition">
                                <i class="fas fa-ruler-vertical text-purple-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">ä¸´è¾¹é˜²æŠ¤</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="environment" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-green-500 peer-checked:bg-green-50 transition">
                                <i class="fas fa-leaf text-green-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">ç¯å¢ƒä¿æŠ¤</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="ppe" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition">
                                <i class="fas fa-hard-hat text-indigo-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">ä¸ªäººé˜²æŠ¤è£…å¤‡</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="hazard-type" value="other" class="peer hidden">
                            <div class="border-2 rounded-lg p-3 text-center peer-checked:border-gray-500 peer-checked:bg-gray-50 transition">
                                <i class="fas fa-ellipsis-h text-gray-500 text-xl mb-1"></i>
                                <p class="text-sm font-medium">å…¶ä»–éšæ‚£</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- ä¸¥é‡ç¨‹åº¦ -->
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <label class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-exclamation-triangle mr-2 text-orange-500"></i>ä¸¥é‡ç¨‹åº¦
                    </label>
                    <select id="severity-level" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="low">ä¸€èˆ¬éšæ‚£ - ç»¿è‰²ç­‰çº§</option>
                        <option value="medium" selected>è¾ƒå¤§éšæ‚£ - é»„è‰²ç­‰çº§</option>
                        <option value="high">é‡å¤§éšæ‚£ - çº¢è‰²ç­‰çº§</option>
                    </select>
                </div>
                
                <!-- ç°åœºç…§ç‰‡ -->
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <label class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-camera mr-2 text-blue-500"></i>ç°åœºç…§ç‰‡
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-600">ç‚¹å‡»æˆ–æ‹ç…§ä¸Šä¼ </p>
                        <p class="text-xs text-gray-400 mt-1">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤š9å¼ </p>
                    </div>
                </div>

                <!-- ä½ç½®ä¿¡æ¯ -->
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <label class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-map-marker-alt mr-2 text-green-500"></i>ä½ç½®ä¿¡æ¯
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="location" class="flex-1 p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å…·ä½“ä½ç½®">
                        <button type="button" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                </div>
                
                <!-- è¯¦ç»†æè¿° -->
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <label for="description" class="block text-gray-700 font-semibold mb-3">
                        <i class="fas fa-edit mr-2 text-purple-500"></i>è¯¦ç»†æè¿°
                    </label>
                    <textarea id="description" rows="4" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¯¦ç»†æè¿°éšæ‚£æƒ…å†µã€å¯èƒ½çš„é£é™©ç­‰..."></textarea>
                </div>
                
                <!-- æäº¤æŒ‰é’® -->
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="showView('main-view')" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="flex-1 btn-primary text-white font-semibold py-3 px-6 rounded-lg shadow-lg">
                        <i class="fas fa-paper-plane mr-2"></i>
                        æäº¤ä¸¾æŠ¥
                    </button>
                </div>
            </form>
        </div>

        <!-- è§†å›¾ 4: è¯¦æƒ…é¡µ -->
        <div id="detail-view" class="view p-4 pb-20">
            <div id="detail-content" class="space-y-4">
                <!-- è¯¦æƒ…å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="detail-actions" class="mt-6">
                <!-- æ“ä½œæŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è§†å›¾ 5: ç»Ÿè®¡é¡µé¢ -->
        <div id="stats-view" class="view p-4 pb-20">
            <h2 class="text-xl font-bold mb-4 text-gray-800" id="stats-title">æ•°æ®ç»Ÿè®¡</h2>

            <!-- æ€»è§ˆå¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                    <div class="text-2xl font-bold" id="total-reports">0</div>
                    <div class="text-sm opacity-90" id="total-reports-label">æ€»ä¸¾æŠ¥æ•°</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white">
                    <div class="text-2xl font-bold" id="resolution-rate">0%</div>
                    <div class="text-sm opacity-90">è§£å†³ç‡</div>
                </div>
            </div>
            
            <!-- æ—¶é—´ç­›é€‰ -->
            <div class="bg-white rounded-xl p-4 border border-gray-200 mb-4">
                <h3 class="text-lg font-semibold mb-3">æ—¶é—´ç­›é€‰</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="filterByTimeRange('week')" class="time-filter-btn bg-blue-500 text-white py-2 px-4 rounded-lg text-sm font-medium transition hover:bg-blue-600" data-range="week">
                        æœ€è¿‘ä¸€å‘¨
                    </button>
                    <button onclick="filterByTimeRange('month')" class="time-filter-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium transition hover:bg-gray-300" data-range="month">
                        æœ€è¿‘ä¸€æœˆ
                    </button>
                    <button onclick="filterByTimeRange('quarter')" class="time-filter-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium transition hover:bg-gray-300" data-range="quarter">
                        æœ€è¿‘ä¸‰æœˆ
                    </button>
                    <button onclick="filterByTimeRange('all')" class="time-filter-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium transition hover:bg-gray-300" data-range="all">
                        å…¨éƒ¨æ—¶é—´
                    </button>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="bg-white rounded-xl p-4 border border-gray-200 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">éšæ‚£ç±»å‹åˆ†å¸ƒ</h3>
                    <span id="time-range-display" class="text-sm text-gray-500">æ—¶é—´èŒƒå›´: æœ€è¿‘ä¸€å‘¨</span>
                </div>
                <div class="chart-container">
                    <canvas id="hazard-type-chart"></canvas>
                </div>
            </div>
            
            </div>

        <!-- è§†å›¾ 6: æˆ‘çš„ä¸¾æŠ¥/å¤„ç†è®°å½•é¡µé¢ -->
        <div id="my-reports-view" class="view p-4 pb-20">
            <h2 class="text-xl font-bold mb-4 text-gray-800" id="my-page-title">æˆ‘çš„ä¸¾æŠ¥</h2>

            <!-- å®‰å…¨ç¯ä¿éƒ¨ä¸“ç”¨ï¼šåŠŸèƒ½èœå• -->
            <div id="manager-menu" class="hidden space-y-3 mb-4">
                <button onclick="showSafetyKnowledgeManagement()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg flex items-center justify-center hover:shadow-xl transition-all mb-3">
                    <i class="fas fa-book-open mr-3 text-xl"></i>
                    å®‰å…¨çŸ¥è¯†ç»´æŠ¤
                </button>
            </div>

            <!-- çŠ¶æ€æ ‡ç­¾å¡ç‰‡ï¼ˆå‘˜å·¥å’Œå®‰å…¨ç¯ä¿éƒ¨éƒ½æ˜¾ç¤ºï¼‰ -->
            <div id="stats-cards" class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="filterMyReports('pending')" class="filter-card bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-4 text-white text-center transition-all duration-300 hover:shadow-lg active:scale-95 border-4 border-transparent">
                    <div class="text-2xl font-bold" id="my-pending-count">0</div>
                    <div class="text-xs opacity-90 mt-1" id="my-pending-label">å·²æäº¤</div>
                </button>
                <button onclick="filterMyReports('processing')" class="filter-card bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-4 text-white text-center transition-all duration-300 hover:shadow-lg active:scale-95 border-4 border-transparent">
                    <div class="text-2xl font-bold" id="my-processing-count">0</div>
                    <div class="text-xs opacity-90 mt-1">å¤„ç†ä¸­</div>
                </button>
                <button onclick="filterMyReports('closed')" class="filter-card bg-gradient-to-br from-green-400 to-green-600 rounded-xl p-4 text-white text-center transition-all duration-300 hover:shadow-lg active:scale-95 border-4 border-transparent">
                    <div class="text-2xl font-bold" id="my-closed-count">0</div>
                    <div class="text-xs opacity-90 mt-1">å·²åŠç»“</div>
                </button>
            </div>

            <!-- ä¸¾æŠ¥åˆ—è¡¨ï¼ˆå‘˜å·¥å’Œå®‰å…¨ç¯ä¿éƒ¨éƒ½æ˜¾ç¤ºï¼‰ -->
            <div id="my-reports-list" class="space-y-3">
                <!-- ä¸¾æŠ¥åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®æŒ‰é’® -->
    <button id="floating-btn" class="floating-btn hidden bg-red-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center" onclick="emergencyReport()">
        <i class="fas fa-exclamation text-xl"></i>
    </button>

<script>
    // --- æ¨¡æ‹Ÿæ•°æ®åº“å’ŒçŠ¶æ€ ---
    let currentUser = null;
    let currentSection = null; // å½“å‰é€‰æ‹©çš„æ ‡æ®µ
    let notifications = [];
    let charts = {};
      let currentTimeFilter = 'week'; // é»˜è®¤æ˜¾ç¤ºæœ€è¿‘ä¸€å‘¨
    let db = {
        users: {
            'employee': { 
                name: 'å‘˜å·¥', 
                role: 'employee', 
                department: 'ç”Ÿäº§è½¦é—´',
                avatar: 'ğŸ‘·',
                phone: '138****1234'
            },
            'manager': {
                name: 'å®‰å…¨ç¯ä¿éƒ¨',
                role: 'manager',
                department: 'å®‰å…¨éƒ¨é—¨',
                avatar: 'ğŸ‘©â€ğŸ’¼',
                phone: '137****9012'
            }
        },
        safetyKnowledge: [
            {
                id: 1,
                category: 'fire',
                title: 'æ¶ˆé˜²å®‰å…¨åŸºç¡€çŸ¥è¯†',
                content: '1. ç«ç¾é¢„é˜²ï¼šå®šæœŸæ£€æŸ¥ç”µæ°”çº¿è·¯ï¼Œä¸è¶…è´Ÿè·ç”¨ç”µï¼Œæ˜“ç‡ƒç‰©å“è¿œç¦»ç«æºã€‚\n2. ç­ç«å™¨ä½¿ç”¨ï¼šæ‹”æ‰ä¿é™©é”€ï¼Œå¯¹å‡†ç«æºæ ¹éƒ¨ï¼ŒæŒ‰ä¸‹å‹æŠŠè¿›è¡Œç­ç«ã€‚\n3. ç–æ•£é€ƒç”Ÿï¼šç†Ÿæ‚‰å®‰å…¨å‡ºå£ä½ç½®ï¼Œä½å§¿åŠ¿æ²¿å¢™å£é€ƒç”Ÿï¼Œä¸ä¹˜åç”µæ¢¯ã€‚',
                uploadedBy: 'admin',
                uploadTime: new Date().toISOString(),
                fileType: 'text'
            },
            {
                id: 2,
                category: 'electric',
                title: 'ç”¨ç”µå®‰å…¨æ“ä½œè§„ç¨‹',
                content: '1. æ¹¿æ‰‹ä¸æ¥è§¦ç”µå™¨ï¼Œé˜²æ­¢è§¦ç”µäº‹æ•…ã€‚\n2. å®šæœŸæ£€æŸ¥ç”µç¼†çº¿è·¯ï¼Œå‘ç°ç ´æŸç«‹å³æ›´æ¢ã€‚\n3. ä½¿ç”¨åˆæ ¼çš„ç”µæ°”è®¾å¤‡ï¼Œä¸ä½¿ç”¨ä¸‰æ— äº§å“ã€‚\n4. ç”µæ°”è®¾å¤‡è¦æœ‰è‰¯å¥½çš„æ¥åœ°ä¿æŠ¤ã€‚',
                uploadedBy: 'admin',
                uploadTime: new Date().toISOString(),
                fileType: 'text'
            },
            {
                id: 3,
                category: 'height',
                title: 'é«˜å¤„ä½œä¸šå®‰å…¨è¦ç‚¹',
                content: '1. 2ç±³ä»¥ä¸Šä½œä¸šå¿…é¡»ç³»å®‰å…¨å¸¦ã€‚\n2. æ£€æŸ¥è„šæ‰‹æ¶ç¨³å›ºæ€§ï¼Œç¡®ä¿æ‰¿é‡å®‰å…¨ã€‚\n3. æ¶åŠ£å¤©æ°”ç¦æ­¢é«˜å¤„ä½œä¸šã€‚\n4. ä½œä¸šå·¥å…·è¦ç³»ç»³é˜²å è½ã€‚',
                uploadedBy: 'admin',
                uploadTime: new Date().toISOString(),
                fileType: 'text'
            }
        ],
        nextKnowledgeId: 4,
        safetyDocuments: [
            // ç¤ºä¾‹æ–‡æ¡£
            {
                id: 1,
                title: 'å®‰å…¨ç”Ÿäº§ç®¡ç†åˆ¶åº¦',
                fileName: 'safety_management_2024.pdf',
                fileSize: 2048576, // 2MB
                fileType: 'application/pdf',
                uploadTime: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // 7å¤©å‰
                uploadedBy: 'å®‰å…¨ç¯ä¿éƒ¨'
            },
            {
                id: 2,
                title: 'æ¶ˆé˜²å™¨æä½¿ç”¨è§„èŒƒ',
                fileName: 'fire_equipment_guide.docx',
                fileSize: 1048576, // 1MB
                fileType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                uploadTime: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), // 3å¤©å‰
                uploadedBy: 'å®‰å…¨ç¯ä¿éƒ¨'
            }
        ],
        nextDocumentId: 3,
        reports: [
            // === å·²æäº¤/å¾…å¤„ç†çŠ¶æ€ (submitted) - 2æ¡ ===
            {
                id: 1,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'ç”Ÿäº§è½¦é—´BåŒºæ¶ˆé˜²é€šé“è¢«çº¸ç®±å µå¡ï¼Œå­˜åœ¨ä¸¥é‡å®‰å…¨éšæ‚£ã€‚çº¸ç®±å †ç§¯é«˜åº¦çº¦1.5ç±³ï¼Œä¸¥é‡å½±å“ç´§æ€¥ç–æ•£é€šé“ã€‚',
                hazardType: 'fire',
                severity: 'high',
                location: 'ç”Ÿäº§è½¦é—´BåŒºä¸œä¾§æ¶ˆé˜²é€šé“',
                initialImages: ['https://placehold.co/600x400/fecaca/ef4444?text=æ¶ˆé˜²é€šé“å µå¡'],
                status: 'submitted',
                assignedTo: null,
                assignedToId: null,
                plan: null,
                rectifiedImages: [],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†é‡å¤§éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 1800000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 1800000),
                feedback: null,
                section: 'TJ01' // æ·»åŠ æ ‡æ®µå­—æ®µ
            },
            {
                id: 2,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'ä»“åº“åŒºåŸŸç…§æ˜è®¾å¤‡æŸåï¼Œå¤šå¤„ç¯ç®¡ä¸äº®ï¼Œå­˜åœ¨ä½œä¸šå®‰å…¨éšæ‚£ã€‚',
                hazardType: 'other',
                severity: 'medium',
                location: 'ä»“åº“AåŒº',
                initialImages: ['https://placehold.co/600x400/fde68a/f59e0b?text=ç…§æ˜æŸå'],
                status: 'submitted',
                assignedTo: null,
                assignedToId: null,
                plan: null,
                rectifiedImages: [],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†å…¶ä»–éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 900000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 900000),
                feedback: null,
                section: 'TJ01'
            },

            // === å¤„ç†ä¸­çŠ¶æ€ (pending_rectification) - 3æ¡ ===
            {
                id: 3,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'è½¦é—´é…ç”µç®±é—¨æ¾åŠ¨ï¼Œç”µçº¿è£¸éœ²ï¼Œå­˜åœ¨è§¦ç”µé£é™©ã€‚',
                hazardType: 'electric',
                severity: 'medium',
                location: 'ç”Ÿäº§è½¦é—´AåŒºé…ç”µç®±',
                initialImages: ['https://placehold.co/600x400/fde68a/f59e0b?text=é…ç”µç®±éšæ‚£'],
                status: 'pending_rectification',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'æ›´æ¢é…ç”µç®±é—¨ï¼Œç»ç¼˜å¤„ç†è£¸éœ²ç”µçº¿ï¼Œå…¨é¢æ£€æŸ¥ç”µè·¯å®‰å…¨ã€‚',
                rectifiedImages: [],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†ç”¨ç”µéšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 5400000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', content: 'æ•´æ”¹æ–¹æ¡ˆï¼šæ›´æ¢é…ç”µç®±é—¨ï¼Œç»ç¼˜å¤„ç†è£¸éœ²ç”µçº¿ï¼Œå…¨é¢æ£€æŸ¥ç”µè·¯å®‰å…¨ã€‚', timestamp: new Date(Date.now() - 5200000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 5400000),
                feedback: null,
                section: 'TJ01'
            },
            {
                id: 4,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'æ…æ‹Œæœºé˜²æŠ¤ç½©ç¼ºå¤±ï¼Œè¿è¡Œæ—¶å­˜åœ¨æœºæ¢°ä¼¤å®³é£é™©ã€‚',
                hazardType: 'mechanical',
                severity: 'high',
                location: 'æ··å‡åœŸæ…æ‹Œç«™2å·æœº',
                initialImages: ['https://placehold.co/600x400/fecaca/ef4444?text=é˜²æŠ¤ç½©ç¼ºå¤±'],
                status: 'pending_rectification',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'ç«‹å³åœç”¨è®¾å¤‡ï¼Œè¡¥è£…é˜²æŠ¤ç½©ï¼Œå…¨é¢æ£€æŸ¥æ‰€æœ‰è®¾å¤‡é˜²æŠ¤è£…ç½®ã€‚',
                rectifiedImages: [],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†è®¾å¤‡éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 4800000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', content: 'æ•´æ”¹æ–¹æ¡ˆï¼šç«‹å³åœç”¨è®¾å¤‡ï¼Œè¡¥è£…é˜²æŠ¤ç½©ã€‚', timestamp: new Date(Date.now() - 4700000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 4800000),
                feedback: null,
                section: 'TJ02'
            },
            {
                id: 5,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'æ–½å·¥ç°åœºå®‰å…¨è­¦ç¤ºæ ‡è¯†ä¸æ¸…æ™°ï¼Œéƒ¨åˆ†æ ‡è¯†ç ´æŸè„±è½ã€‚',
                hazardType: 'other',
                severity: 'low',
                location: 'æ–½å·¥ç°åœºDåŒº',
                initialImages: ['https://placehold.co/600x400/dbeafe/3b82f6?text=æ ‡è¯†ç ´æŸ'],
                status: 'pending_rectification',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'æ›´æ¢æ‰€æœ‰ç ´æŸæ ‡è¯†ï¼Œè¡¥å……ç¼ºå¤±çš„å®‰å…¨è­¦ç¤ºç‰Œã€‚',
                rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=æ ‡è¯†å·²æ›´æ¢'],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†å…¶ä»–éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 3600000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 3400000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'ä¸Šä¼ äº†æ•´æ”¹ç…§ç‰‡ï¼Œå¾…åŠç»“', timestamp: new Date(Date.now() - 1200000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 3600000),
                feedback: null,
                section: 'TJ02'
            },

            // === å·²åŠç»“çŠ¶æ€ (closed) - 5æ¡ ===
            {
                id: 6,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'åŠå…¬åŒºåŸŸç­ç«å™¨è¿‡æœŸæœªæ£€ï¼Œéœ€è¦åŠæ—¶æ›´æ¢ã€‚',
                hazardType: 'fire',
                severity: 'medium',
                location: 'åŠå…¬æ¥¼3å±‚ä¸œä¾§',
                initialImages: ['https://placehold.co/600x400/fde68a/f59e0b?text=ç­ç«å™¨è¿‡æœŸ'],
                status: 'closed',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'æ›´æ¢æ‰€æœ‰è¿‡æœŸç­ç«å™¨ï¼Œå»ºç«‹å®šæœŸæ£€æŸ¥æœºåˆ¶ã€‚',
                rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=å·²æ›´æ¢ç­ç«å™¨'],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†æ¶ˆé˜²éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 10800000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 10600000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', content: 'å·²æ›´æ¢æ‰€æœ‰è¿‡æœŸç­ç«å™¨ï¼Œå»ºç«‹æœˆåº¦æ£€æŸ¥å°è´¦ã€‚', timestamp: new Date(Date.now() - 7200000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 10800000),
                feedback: null,
                section: 'TJ01'
            },
            {
                id: 7,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'ä¸´æ—¶ç”¨ç”µçº¿è·¯ç§æ‹‰ä¹±æ¥ï¼Œå­˜åœ¨ç«ç¾éšæ‚£ã€‚',
                hazardType: 'electric',
                severity: 'high',
                location: 'æ–½å·¥ç°åœºä¸´æ—¶ç”¨ç”µåŒº',
                initialImages: ['https://placehold.co/600x400/fecaca/ef4444?text=çº¿è·¯ä¹±æ¥'],
                status: 'closed',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'æ‹†é™¤è¿è§„çº¿è·¯ï¼Œè§„èŒƒå¸ƒè®¾ä¸´æ—¶ç”¨ç”µï¼Œå®‰è£…æ¼ç”µä¿æŠ¤è£…ç½®ã€‚',
                rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=çº¿è·¯è§„èŒƒ'],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†é‡å¤§éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 14400000).toLocaleString() },
                    { user: 'ç³»ç»Ÿ', action: 'éšæ‚£å·²è‡ªåŠ¨å‡çº§ä¸ºç´§æ€¥ä»»åŠ¡', timestamp: new Date(Date.now() - 14300000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 14200000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', content: 'å·²æ‹†é™¤è¿è§„çº¿è·¯ï¼Œé‡æ–°è§„èŒƒå¸ƒè®¾ï¼Œå®‰è£…äº†æ¼ç”µä¿æŠ¤ã€‚', timestamp: new Date(Date.now() - 10800000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 14400000),
                feedback: null,
                section: 'TJ02'
            },
            {
                id: 8,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'é’¢ç­‹åŠ å·¥åŒºé˜²æŠ¤æ æ†é«˜åº¦ä¸è¶³ï¼Œå­˜åœ¨å è½é£é™©ã€‚',
                hazardType: 'other',
                severity: 'medium',
                location: 'é’¢ç­‹åŠ å·¥æ£š',
                initialImages: ['https://placehold.co/600x400/fde68a/f59e0b?text=æŠ¤æ ä¸è¶³'],
                status: 'closed',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'åŠ é«˜é˜²æŠ¤æ æ†è‡³1.2ç±³ï¼Œå¢åŠ ä¸­é—´æ¨ªæ†å’ŒæŒ¡è„šæ¿ã€‚',
                rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=æŠ¤æ åŠ é«˜'],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†å…¶ä»–éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 18000000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 17800000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', content: 'å·²åŠ é«˜æŠ¤æ è‡³æ ‡å‡†é«˜åº¦ï¼Œå¢è®¾æ¨ªæ†å’ŒæŒ¡è„šæ¿ã€‚', timestamp: new Date(Date.now() - 14400000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 18000000),
                feedback: null,
                section: 'TJ01'
            },
            {
                id: 9,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'æœºæ¢°è½¦é—´åœ°é¢æœ‰æ²¹æ±¡ï¼Œå®¹æ˜“å¯¼è‡´äººå‘˜æ»‘å€’å—ä¼¤ã€‚',
                hazardType: 'other',
                severity: 'low',
                location: 'æœºæ¢°è½¦é—´3å·åŒºåŸŸ',
                initialImages: ['https://placehold.co/600x400/dbeafe/3b82f6?text=åœ°é¢æ²¹æ±¡'],
                status: 'closed',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'æ¸…ç†åœ°é¢æ²¹æ±¡ï¼Œè®¾ç½®é˜²æ»‘å«ï¼Œå»ºç«‹æ—¥å¸¸æ¸…æ´åˆ¶åº¦ã€‚',
                rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=åœ°é¢æ¸…æ´'],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†å…¶ä»–éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 21600000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 21400000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', content: 'å·²æ¸…ç†åœ°é¢ï¼Œè®¾ç½®é˜²æ»‘å«ï¼Œå»ºç«‹æ¯æ—¥æ¸…æ´åˆ¶åº¦ã€‚', timestamp: new Date(Date.now() - 18000000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 21600000),
                feedback: null,
                section: 'TJ02'
            },
            {
                id: 10,
                reporter: 'å‘˜å·¥',
                reporterId: 'employee',
                description: 'è„šæ‰‹æ¶æ­è®¾ä¸è§„èŒƒï¼Œç¼ºå°‘è¿å¢™ä»¶ï¼Œå­˜åœ¨å€’å¡Œé£é™©ã€‚',
                hazardType: 'mechanical',
                severity: 'high',
                location: 'å¤–å¢™æ–½å·¥è„šæ‰‹æ¶',
                initialImages: ['https://placehold.co/600x400/fecaca/ef4444?text=è„šæ‰‹æ¶éšæ‚£'],
                status: 'closed',
                assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
                assignedToId: 'manager',
                plan: 'æŒ‰è§„èŒƒå¢è®¾è¿å¢™ä»¶ï¼ŒåŠ å›ºè„šæ‰‹æ¶ï¼ŒéªŒæ”¶åˆæ ¼åæ–¹å¯ä½¿ç”¨ã€‚',
                rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=è„šæ‰‹æ¶åŠ å›º'],
                history: [
                    { user: 'å‘˜å·¥', action: 'æäº¤äº†é‡å¤§éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 25200000).toLocaleString() },
                    { user: 'ç³»ç»Ÿ', action: 'éšæ‚£å·²è‡ªåŠ¨å‡çº§ä¸ºç´§æ€¥ä»»åŠ¡', timestamp: new Date(Date.now() - 25100000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 25000000).toLocaleString() },
                    { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', content: 'å·²æŒ‰è§„èŒƒå¢è®¾è¿å¢™ä»¶ï¼Œé€šè¿‡éªŒæ”¶ã€‚', timestamp: new Date(Date.now() - 21600000).toLocaleString() }
                ],
                createdAt: new Date(Date.now() - 25200000),
                feedback: null,
                section: 'TJ01'
            },
          // === æ›´æ—©æœŸçš„æ•°æ® - 2å‘¨å‰ ===
          {
              id: 11,
              reporter: 'å‘˜å·¥',
              reporterId: 'employee',
              description: 'æ–½å·¥åŒºåŸŸå®‰å…¨ç½‘ç ´æŸï¼Œå­˜åœ¨é«˜ç©ºå ç‰©é£é™©ã€‚',
              hazardType: 'mechanical',
              severity: 'high',
              location: 'ä¸»ä½“ç»“æ„æ–½å·¥åŒº',
              initialImages: ['https://placehold.co/600x400/fecaca/ef4444?text=å®‰å…¨ç½‘ç ´æŸ'],
              status: 'closed',
              assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
              assignedToId: 'manager',
              plan: 'æ›´æ¢ç ´æŸå®‰å…¨ç½‘ï¼ŒåŠ å¼ºæ—¥å¸¸å·¡æ£€',
              rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=å®‰å…¨ç½‘å·²æ›´æ¢'],
              history: [
                  { user: 'å‘˜å·¥', action: 'æäº¤äº†é‡å¤§éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toLocaleString() },
                  { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000 + 3600000).toLocaleString() },
                  { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000 + 7200000).toLocaleString() }
              ],
              createdAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000),
              feedback: null,
              section: 'TJ02'
          },
          // === 1ä¸ªæœˆå‰çš„æ•°æ® ===
          {
              id: 12,
              reporter: 'å‘˜å·¥',
              reporterId: 'employee',
              description: 'é£Ÿå ‚ç‡ƒæ°”ç®¡é“è¿æ¥å¤„æœ‰è½»å¾®æ³„æ¼ï¼Œéœ€è¦ç´§æ€¥å¤„ç†ã€‚',
              hazardType: 'fire',
              severity: 'medium',
              location: 'é¡¹ç›®é£Ÿå ‚å¨æˆ¿',
              initialImages: ['https://placehold.co/600x400/fde68a/f59e0b?text=ç‡ƒæ°”æ³„æ¼'],
              status: 'closed',
              assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
              assignedToId: 'manager',
              plan: 'æ›´æ¢ç‡ƒæ°”ç®¡é“å¯†å°ä»¶ï¼Œå…¨é¢æ£€æŸ¥ç‡ƒæ°”ç³»ç»Ÿ',
              rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=ç®¡é“å·²ä¿®å¤'],
              history: [
                  { user: 'å‘˜å·¥', action: 'æäº¤äº†æ¶ˆé˜²éšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000).toLocaleString() },
                  { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000 + 1800000).toLocaleString() },
                  { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', timestamp: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000 + 5400000).toLocaleString() }
              ],
              createdAt: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000),
              feedback: null,
              section: 'TJ01'
          },
          // === 2ä¸ªæœˆå‰çš„æ•°æ® ===
          {
              id: 13,
              reporter: 'å‘˜å·¥',
              reporterId: 'employee',
              description: 'ä¸´æ—¶å·¥æ£šç”µæ°”çº¿è·¯è€åŒ–ï¼Œå­˜åœ¨ç«ç¾éšæ‚£ã€‚',
              hazardType: 'electric',
              severity: 'medium',
              location: 'ç”Ÿæ´»åŒºä¸´æ—¶å·¥æ£š',
              initialImages: ['https://placehold.co/600x400/fde68a/f59e0b?text=çº¿è·¯è€åŒ–'],
              status: 'closed',
              assignedTo: 'å®‰å…¨ç¯ä¿éƒ¨',
              assignedToId: 'manager',
              plan: 'æ›´æ¢è€åŒ–çº¿è·¯ï¼Œå®‰è£…æ¼ç”µä¿æŠ¤å™¨',
              rectifiedImages: ['https://placehold.co/600x400/dcfce7/22c55e?text=çº¿è·¯å·²æ›´æ¢'],
              history: [
                  { user: 'å‘˜å·¥', action: 'æäº¤äº†ç”¨ç”µéšæ‚£ä¸¾æŠ¥', timestamp: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toLocaleString() },
                  { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å·²æ¥æ”¶æ•´æ”¹ä»»åŠ¡', timestamp: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000 + 2400000).toLocaleString() },
                  { user: 'å®‰å…¨ç¯ä¿éƒ¨', action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“', timestamp: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000 + 7200000).toLocaleString() }
              ],
              createdAt: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000),
              feedback: null,
              section: 'TJ02'
          }
        ],
        nextReportId: 14
    };

    // --- æ ‡æ®µé€‰æ‹©åŠŸèƒ½ ---
    function selectSection(section) {
        currentSection = section;
        document.getElementById('section-title').textContent = `ç¬¬${section}æ ‡æ®µ`;
        showView('section-view');
    }

    function goBack() {
        if (currentUser) {
            showView('main-view');
        } else if (currentSection) {
            showView('section-view');
        } else {
            showView('login-view');
        }
    }

    // æ ¹æ®å½“å‰æ ‡æ®µç­›é€‰æŠ¥å‘Š
    function getFilteredReports() {
        if (!currentSection) return db.reports;
        return db.reports.filter(report => report.section === currentSection);
    }

    // --- è§†å›¾åˆ‡æ¢å’Œæ¸²æŸ“ ---
    const views = document.querySelectorAll('.view');
    const appHeader = document.getElementById('app-header');
    const bottomNav = document.getElementById('bottom-nav');
    const floatingBtn = document.getElementById('floating-btn');

    function showView(viewId) {
        views.forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');

        const showHeader = !['login-view', 'section-view'].includes(viewId);
        appHeader.style.display = showHeader ? 'block' : 'none';
        bottomNav.style.display = showHeader ? 'block' : 'none';
        floatingBtn.style.display = (showHeader && currentUser?.role === 'employee') ? 'flex' : 'none';

        // æ›´æ–°åº•éƒ¨å¯¼èˆªçŠ¶æ€
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-blue-600');
            item.classList.add('text-gray-600');
        });

        // æ ¹æ®è§†å›¾æ›´æ–°å¯¼èˆªçŠ¶æ€
        const navMap = {
            'main-view': 0,
            'stats-view': 1,
            'my-reports-view': 2
        };

        if (navMap[viewId] !== undefined) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems[navMap[viewId]].classList.remove('text-gray-600');
            navItems[navMap[viewId]].classList.add('text-blue-600');
        }

        // æ ¹æ®è§†å›¾åŠ è½½ç›¸åº”æ•°æ®
        if (viewId === 'main-view') {
            renderMainView();
        } else if (viewId === 'stats-view') {
            renderStatsView();
        } else if (viewId === 'my-reports-view') {
            renderMyReportsView();
        }
    }

    function loginAs(role) {
        currentUser = db.users[role];
        document.getElementById('header-title').innerText = `ç¬¬${currentSection}æ ‡æ®µ - ${currentUser.name}`;
        showNotification('ç™»å½•æˆåŠŸ', `æ¬¢è¿å›æ¥ï¼Œç¬¬${currentSection}æ ‡æ®µ${currentUser.name}ï¼`, 'success');
        showView('main-view');
        updateNotificationBadge();
    }

    function logout() {
        currentUser = null;
        currentSection = null; // é‡ç½®æ ‡æ®µä¿¡æ¯
        showNotification('é€€å‡ºç™»å½•', 'æ‚¨å·²å®‰å…¨é€€å‡ºç³»ç»Ÿ', 'info');
        showView('login-view');
    }

    function renderMainView() {
        // éšè—æ‰€æœ‰ä»ªè¡¨æ¿
        document.getElementById('employee-dashboard').style.display = 'none';
        document.getElementById('manager-dashboard').style.display = 'none';

        if (currentUser.role === 'employee') {
            document.getElementById('employee-dashboard').style.display = 'block';
            renderEmployeeDashboard();
        } else if (currentUser.role === 'manager') {
            document.getElementById('manager-dashboard').style.display = 'block';
            renderManagerDashboard();
        }
    }

    function renderEmployeeDashboard() {
        const myReports = getFilteredReports().filter(r => r.reporterId === currentUser.role);

        // å·²æäº¤ï¼šsubmittedçŠ¶æ€
        const pendingReports = myReports.filter(r => r.status === 'submitted');
        // å¤„ç†ä¸­ï¼špending_rectification
        const processingReports = myReports.filter(r => r.status === 'pending_rectification');
        // å·²åŠç»“ï¼šclosed
        const closedReports = myReports.filter(r => r.status === 'closed');

        document.getElementById('home-pending-count').textContent = pendingReports.length;
        document.getElementById('home-processing-count').textContent = processingReports.length;
        document.getElementById('home-closed-count').textContent = closedReports.length;

        renderReportsList();
    }

    // å®‰å…¨ç»ç†ç›¸å…³å˜é‡å’Œå‡½æ•°
    let currentManagerFilter = 'pending'; // å½“å‰ç­›é€‰çŠ¶æ€

    function renderManagerDashboard() {
        currentManagerFilter = 'pending'; // é»˜è®¤æ˜¾ç¤ºå¾…å¤„ç†
        updateManagerReportsStats();
        filterManagerReports('pending');
    }

    function updateManagerReportsStats() {
        const filteredReports = getFilteredReports();
        // å¾…å¤„ç†ï¼šsubmittedçŠ¶æ€
        const pendingReports = filteredReports.filter(r => r.status === 'submitted');
        // å¤„ç†ä¸­ï¼špending_rectification
        const processingReports = filteredReports.filter(r => r.status === 'pending_rectification');
        // å·²åŠç»“ï¼šclosed
        const closedReports = filteredReports.filter(r => r.status === 'closed');

        document.getElementById('manager-pending-count').textContent = pendingReports.length;
        document.getElementById('manager-processing-count').textContent = processingReports.length;
        document.getElementById('manager-closed-count').textContent = closedReports.length;
    }

    function filterManagerReports(status) {
        currentManagerFilter = status;

        // æ›´æ–°å¡ç‰‡æ ·å¼ï¼šé€‰ä¸­çš„å¡ç‰‡æ·»åŠ ç™½è‰²è¾¹æ¡†é«˜äº®
        const cards = document.querySelectorAll('.manager-filter-card');
        cards.forEach(card => {
            card.classList.remove('border-white', 'shadow-xl', 'scale-105');
            card.classList.add('border-transparent');
        });

        const activeCardIndex = status === 'pending' ? 0 : status === 'processing' ? 1 : 2;
        cards[activeCardIndex].classList.remove('border-transparent');
        cards[activeCardIndex].classList.add('border-white', 'shadow-xl', 'scale-105');

        // æ›´æ–°åˆ—è¡¨æ ‡é¢˜
        const titleMap = {
            'pending': 'å¾…å¤„ç†ä¸¾æŠ¥',
            'processing': 'å¤„ç†ä¸­ä¸¾æŠ¥',
            'closed': 'å·²åŠç»“ä¸¾æŠ¥'
        };
        document.getElementById('manager-list-title').textContent = titleMap[status];

        // ç­›é€‰å¹¶æ¸²æŸ“åˆ—è¡¨
        renderManagerFilteredReports(status);
    }

    function renderManagerFilteredReports(status) {
        const listEl = document.getElementById('manager-reports-list');

        let filteredReports = [];
        const allReports = getFilteredReports();
        if (status === 'pending') {
            filteredReports = allReports.filter(r => r.status === 'submitted');
        } else if (status === 'processing') {
            filteredReports = allReports.filter(r => r.status === 'pending_rectification');
        } else if (status === 'closed') {
            filteredReports = allReports.filter(r => r.status === 'closed');
        }

        if (filteredReports.length === 0) {
            const emptyMessages = {
                'pending': 'æš‚æ— å¾…å¤„ç†çš„ä¸¾æŠ¥',
                'processing': 'æš‚æ— å¤„ç†ä¸­çš„ä¸¾æŠ¥',
                'closed': 'æš‚æ— å·²åŠç»“çš„ä¸¾æŠ¥'
            };
            listEl.innerHTML = `
                <div class="text-center py-12 bg-gray-50 rounded-xl">
                    <i class="fas fa-clipboard-check text-5xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">${emptyMessages[status]}</p>
                </div>
            `;
            return;
        }

        listEl.innerHTML = filteredReports.reverse().map(report => {
            const severityClass = report.severity === 'high' ? 'safety-level-high' :
                                report.severity === 'medium' ? 'safety-level-medium' : 'safety-level-low';

            return `
                <div class="bg-white rounded-xl p-4 border ${severityClass} card-hover cursor-pointer" onclick="showDetail(${report.id})">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 mr-3">
                            <div class="flex items-center mb-1">
                                ${getHazardTypeIcon(report.hazardType)}
                                <span class="text-xs text-gray-500 ml-2">ID: #${report.id}</span>
                                ${report.severity === 'high' ? '<span class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-semibold">ç´§æ€¥</span>' : ''}
                            </div>
                            <p class="text-gray-800 line-clamp-2 font-medium">${report.description}</p>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${report.location}</p>
                            <p class="text-xs text-blue-600 mt-1"><i class="fas fa-user mr-1"></i>ä¸¾æŠ¥äºº: ${report.reporter}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${getStatusBadge(report.status)}
                            ${getSeverityBadge(report.severity)}
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>${report.history[0].timestamp}</span>
                    </div>
                </div>
            `;
        }).join('');
    }


    function getStatusBadge(status) {
        const statuses = {
            'submitted': { text: 'å¾…å¤„ç†', color: 'bg-yellow-500', icon: 'fa-clock' },
            'pending_rectification': { text: 'æ•´æ”¹ä¸­', color: 'bg-orange-500', icon: 'fa-tools' },
            'closed': { text: 'å·²åŠç»“', color: 'bg-green-500', icon: 'fa-check-circle' },
            'rejected': { text: 'å·²é©³å›', color: 'bg-red-500', icon: 'fa-times-circle' },
        };
        const s = statuses[status];
        return `<span class="status-badge text-white text-xs font-semibold px-3 py-1 rounded-full inline-flex items-center ${s.color}">
            <i class="fas ${s.icon} mr-1"></i>${s.text}
        </span>`;
    }

    function getSeverityBadge(severity) {
        const severities = {
            'high': { text: 'é‡å¤§', color: 'bg-red-500' },
            'medium': { text: 'è¾ƒå¤§', color: 'bg-yellow-500' },
            'low': { text: 'ä¸€èˆ¬', color: 'bg-green-500' }
        };
        const s = severities[severity];
        return `<span class="text-white text-xs font-semibold px-2 py-1 rounded ${s.color}">${s.text}</span>`;
    }

    function renderReportsList() {
        const listEl = document.getElementById('reports-list');
        const myReports = getFilteredReports().filter(r => r.reporter === currentUser.name).reverse().slice(0, 5);
        
        if (myReports.length === 0) {
            listEl.innerHTML = `
                <div class="text-center py-8 bg-gray-50 rounded-xl">
                    <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">æš‚æ— ä¸¾æŠ¥è®°å½•</p>
                    <p class="text-sm text-gray-400 mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹ä¸¾æŠ¥</p>
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = myReports.map(report => {
            const severityClass = report.severity === 'high' ? 'safety-level-high' : 
                                report.severity === 'medium' ? 'safety-level-medium' : 'safety-level-low';
            
            return `
                <div class="bg-white rounded-xl p-4 border ${severityClass} card-hover cursor-pointer" onclick="showDetail(${report.id})">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 mr-3">
                            <div class="flex items-center mb-1">
                                ${getHazardTypeIcon(report.hazardType)}
                                <span class="text-xs text-gray-500 ml-2">${report.location}</span>
                            </div>
                            <p class="text-gray-800 line-clamp-2">${report.description}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${getStatusBadge(report.status)}
                            ${getSeverityBadge(report.severity)}
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>${report.history[0].timestamp}</span>
                        ${report.assignedTo ? `<span class="text-blue-600">å¤„ç†äºº: ${report.assignedTo}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }



    function getHazardTypeIcon(type) {
        const icons = {
            'fire': '<i class="fas fa-fire text-red-500 mr-2"></i>',
            'electric': '<i class="fas fa-bolt text-yellow-500 mr-2"></i>',
            'mechanical': '<i class="fas fa-cogs text-blue-500 mr-2"></i>',
            'height': '<i class="fas fa-mountain text-orange-500 mr-2"></i>',
            'edge': '<i class="fas fa-ruler-vertical text-purple-500 mr-2"></i>',
            'environment': '<i class="fas fa-leaf text-green-500 mr-2"></i>',
            'ppe': '<i class="fas fa-hard-hat text-indigo-500 mr-2"></i>',
            'other': '<i class="fas fa-exclamation-circle text-gray-500 mr-2"></i>'
        };
        return icons[type] || icons.other;
    }

    function showDetail(id) {
        const report = db.reports.find(r => r.id === id);
        if (!report) return;

        const contentEl = document.getElementById('detail-content');
        const actionsEl = document.getElementById('detail-actions');

        // ç”Ÿæˆè¯¦æƒ…å†…å®¹
        const severityClass = report.severity === 'high' ? 'safety-level-high' : 
                            report.severity === 'medium' ? 'safety-level-medium' : 'safety-level-low';

        let timelineHTML = report.history.map((item, index) => `
            <div class="relative pl-8 py-3 timeline-item">
                <div class="timeline-dot bg-${item.user === 'ç³»ç»Ÿ' ? 'gray' : 'blue'}-500 rounded-full"></div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="font-semibold text-gray-800">${item.action}</p>
                    <p class="text-sm text-gray-600 mt-1">ç”± <span class="font-medium">${item.user}</span></p>
                    ${item.content ? `<p class="text-sm text-gray-700 mt-2 bg-white p-2 rounded border-l-4 border-blue-500">${item.content}</p>` : ''}
                    <p class="text-xs text-gray-400 mt-2">${item.timestamp}</p>
                </div>
            </div>
        `).join('');

        contentEl.innerHTML = `
            <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <div class="bg-white rounded-xl p-4 border ${severityClass} mb-4">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-gray-800">éšæ‚£è¯¦æƒ… #${report.id}</h3>
                    <div class="flex flex-col items-end space-y-2">
                        ${getStatusBadge(report.status)}
                        ${getSeverityBadge(report.severity)}
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center">
                        ${getHazardTypeIcon(report.hazardType)}
                        <span class="text-sm text-gray-600">éšæ‚£ç±»å‹</span>
                    </div>
                    
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                        <span>${report.location}</span>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-700 leading-relaxed">${report.description}</p>
                    </div>
                </div>
            </div>

            <!-- ç…§ç‰‡å±•ç¤º -->
            <div class="bg-white rounded-xl p-4 border border-gray-200 mb-4">
                <h4 class="font-semibold mb-3 text-gray-800">
                    <i class="fas fa-images mr-2 text-blue-500"></i>ç°åœºç…§ç‰‡
                </h4>
                <div class="grid grid-cols-2 gap-2">
                    ${report.initialImages.map(img => `
                        <img src="${img}" class="rounded-lg w-full h-32 object-cover cursor-pointer hover:opacity-90 transition" onclick="viewImage('${img}')">
                    `).join('')}
                </div>
            </div>

            ${report.rectifiedImages.length > 0 ? `
            <div class="bg-white rounded-xl p-4 border border-gray-200 mb-4">
                <h4 class="font-semibold mb-3 text-gray-800">
                    <i class="fas fa-check-circle mr-2 text-green-500"></i>æ•´æ”¹åç…§ç‰‡
                </h4>
                <div class="grid grid-cols-2 gap-2">
                    ${report.rectifiedImages.map(img => `
                        <img src="${img}" class="rounded-lg w-full h-32 object-cover cursor-pointer hover:opacity-90 transition" onclick="viewImage('${img}')">
                    `).join('')}
                </div>
            </div>` : ''}

            <!-- å¤„ç†æµç¨‹ -->
            <div class="bg-white rounded-xl p-4 border border-gray-200">
                <h4 class="font-semibold mb-4 text-gray-800">
                    <i class="fas fa-history mr-2 text-purple-500"></i>å¤„ç†æµç¨‹
                </h4>
                ${timelineHTML}
            </div>
        `;

        // æ ¹æ®è§’è‰²å’ŒçŠ¶æ€æ˜¾ç¤ºä¸åŒæ“ä½œ
        actionsEl.innerHTML = '';
        if (currentUser.role === 'manager' && report.status === 'submitted') {
            actionsEl.innerHTML = `
                <div class="bg-gradient-to-r from-red-500 to-pink-500 rounded-xl p-4 text-white">
                    <h3 class="font-bold mb-3 text-lg">
                        <i class="fas fa-clipboard-check mr-2"></i>ä»»åŠ¡å¤„ç†
                    </h3>
                    <div class="space-y-3">
                        <button onclick="acceptTask(${id})" class="w-full bg-white text-red-500 font-bold py-3 px-6 rounded-lg hover:bg-gray-100 transition">
                            <i class="fas fa-check mr-2"></i>æ¥å—å¹¶ç¡®è®¤
                        </button>
                        <button onclick="closeAsNonHazard(${id})" class="w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition">
                            <i class="fas fa-times mr-2"></i>ä¸æ˜¯éšæ‚£ï¼Œç›´æ¥åŠç»“
                        </button>
                        <button onclick="showRectificationForm(${id})" class="w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-tools mr-2"></i>éœ€è¦æ•´æ”¹
                        </button>
                    </div>
                </div>
                <div id="rectification-form-${id}" class="hidden bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-4 text-white mt-3">
                    <h3 class="font-bold mb-3 text-lg">
                        <i class="fas fa-tools mr-2"></i>æ•´æ”¹å¤„ç†
                    </h3>
                    <div class="space-y-3">
                        <textarea id="plan-input-${id}" class="w-full p-3 border-0 rounded-lg text-gray-800" placeholder="è¯·å¡«å†™æ•´æ”¹æ–¹æ¡ˆ..."></textarea>
                        <div>
                            <label class="block text-sm font-medium mb-2">ä¸Šä¼ æ•´æ”¹åç…§ç‰‡</label>
                            <input type="file" id="rectified-images-${id}" accept="image/*" multiple class="w-full p-2 border-0 rounded-lg text-gray-800" onchange="handleRectifiedImages(event, ${id})">
                            <div id="image-preview-${id}" class="grid grid-cols-2 gap-2 mt-2"></div>
                        </div>
                        <button onclick="submitRectification(${id})" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-check-circle mr-2"></i>ç¡®è®¤åŠç»“
                        </button>
                    </div>
                </div>
            `;
        } else if (currentUser.role === 'manager' && report.status === 'pending_rectification') {
            actionsEl.innerHTML = `
                <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl p-4 text-white">
                    <h3 class="font-bold mb-3 text-lg">
                        <i class="fas fa-tools mr-2"></i>æ•´æ”¹å¤„ç†
                    </h3>
                    <div class="space-y-3">
                        <p class="text-sm opacity-90">è¯·ä¸Šä¼ æ•´æ”¹åç…§ç‰‡å¹¶å¡«å†™æ•´æ”¹æ–¹æ¡ˆï¼Œå®Œæˆåå¯ç›´æ¥åŠç»“</p>
                        <div>
                            <label class="block text-sm font-medium mb-2">æ•´æ”¹æ–¹æ¡ˆ</label>
                            <textarea id="plan-input-${id}" class="w-full p-3 border-0 rounded-lg text-gray-800" placeholder="è¯·æè¿°æ•´æ”¹æªæ–½å’Œç»“æœ..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">ä¸Šä¼ æ•´æ”¹åç…§ç‰‡</label>
                            <input type="file" id="rectified-images-${id}" accept="image/*" multiple class="w-full p-2 border-0 rounded-lg text-gray-800" onchange="handleRectifiedImages(event, ${id})">
                            <div id="image-preview-${id}" class="grid grid-cols-2 gap-2 mt-2"></div>
                        </div>
                        <button onclick="submitRectification(${id})" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-check-circle mr-2"></i>æäº¤æ•´æ”¹å¹¶åŠç»“
                        </button>
                    </div>
                </div>
            `;
        } else if (report.status === 'closed' && report.reporter === currentUser.name) {
            actionsEl.innerHTML = `
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl p-4 text-white">
                    <h3 class="font-bold mb-3 text-lg">
                        <i class="fas fa-medal mr-2"></i>ä¸¾æŠ¥åé¦ˆ
                    </h3>
                    <div class="space-y-3">
                        <p class="text-sm">æ„Ÿè°¢æ‚¨å¯¹å®‰å…¨ç”Ÿäº§çš„é‡è§†ï¼è¯¥éšæ‚£å·²æˆåŠŸè§£å†³ã€‚</p>
                        <div class="bg-white/20 p-3 rounded-lg">
                            <p class="text-sm font-semibold mb-2">è¯·å¯¹å¤„ç†ç»“æœè¿›è¡Œè¯„ä»·:</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 bg-white/30 p-2 rounded hover:bg-white/40 transition">
                                    <i class="fas fa-smile"></i> æ»¡æ„
                                </button>
                                <button class="flex-1 bg-white/30 p-2 rounded hover:bg-white/40 transition">
                                    <i class="fas fa-meh"></i> ä¸€èˆ¬
                                </button>
                                <button class="flex-1 bg-white/30 p-2 rounded hover:bg-white/40 transition">
                                    <i class="fas fa-frown"></i> ä¸æ»¡æ„
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        showView('detail-view');
    }

    function renderStatsView() {
        if (!currentUser) return;

        let totalReports, closedReports, resolutionRate;

        if (currentUser.role === 'employee') {
            // æ™®é€šå‘˜å·¥ï¼šæ˜¾ç¤ºæˆ‘çš„ä¸¾æŠ¥ç»Ÿè®¡
            document.getElementById('stats-title').textContent = 'æˆ‘çš„ä¸¾æŠ¥ç»Ÿè®¡';
            document.getElementById('total-reports-label').textContent = 'æˆ‘çš„ä¸¾æŠ¥æ•°';

            const myReports = getFilteredReports().filter(r => r.reporterId === currentUser.role);
            totalReports = myReports.length;
            closedReports = myReports.filter(r => r.status === 'closed').length;
            resolutionRate = totalReports > 0 ? Math.round((closedReports / totalReports) * 100) : 0;
        } else {
            // å®‰å…¨ç¯ä¿éƒ¨ï¼šæ˜¾ç¤ºå…¨éƒ¨ç»Ÿè®¡
            document.getElementById('stats-title').textContent = 'æ•°æ®ç»Ÿè®¡';
            document.getElementById('total-reports-label').textContent = 'æ€»ä¸¾æŠ¥æ•°';

            const filteredReports = getFilteredReports();
            totalReports = filteredReports.length;
            closedReports = filteredReports.filter(r => r.status === 'closed').length;
            resolutionRate = totalReports > 0 ? Math.round((closedReports / totalReports) * 100) : 0;
        }

        document.getElementById('total-reports').textContent = totalReports;
        document.getElementById('resolution-rate').textContent = resolutionRate + '%';

        renderCharts();
    }

    function renderCharts() {
        if (!currentUser) return;

        // æ ¹æ®è§’è‰²ç­›é€‰æ•°æ®
        let reportsToAnalyze = getFilteredReports();
        if (currentUser.role === 'employee') {
            reportsToAnalyze = reportsToAnalyze.filter(r => r.reporterId === currentUser.role);
        }

        // åº”ç”¨æ—¶é—´ç­›é€‰
        reportsToAnalyze = filterReportsByTime(reportsToAnalyze, currentTimeFilter);

        // éšæ‚£ç±»å‹åˆ†å¸ƒå›¾
        const hazardTypeCtx = document.getElementById('hazard-type-chart');
        if (hazardTypeCtx) {
            if (charts.hazardType) {
                charts.hazardType.destroy();
            }

            const typeCounts = {};
            reportsToAnalyze.forEach(report => {
                typeCounts[report.hazardType] = (typeCounts[report.hazardType] || 0) + 1;
            });

            charts.hazardType = new Chart(hazardTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['æ¶ˆé˜²éšæ‚£', 'ç”¨ç”µéšæ‚£', 'è®¾å¤‡éšæ‚£', 'é«˜å¤„ä½œä¸š', 'ä¸´è¾¹é˜²æŠ¤', 'ç¯å¢ƒä¿æŠ¤', 'ä¸ªäººé˜²æŠ¤è£…å¤‡', 'å…¶ä»–éšæ‚£'],
                    datasets: [{
                        data: [
                            typeCounts.fire || 0,
                            typeCounts.electric || 0,
                            typeCounts.mechanical || 0,
                            typeCounts.height || 0,
                            typeCounts.edge || 0,
                            typeCounts.environment || 0,
                            typeCounts.ppe || 0,
                            typeCounts.other || 0
                        ],
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#3b82f6',
                            '#f97316',
                            '#a855f7',
                            '#22c55e',
                            '#6366f1',
                            '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
  
      }

      // æ—¶é—´ç­›é€‰åŠŸèƒ½
      function filterByTimeRange(range) {
          currentTimeFilter = range;

          // æ›´æ–°æŒ‰é’®æ ·å¼
          const buttons = document.querySelectorAll('.time-filter-btn');
          buttons.forEach(btn => {
              if (btn.dataset.range === range) {
                  btn.classList.remove('bg-gray-200', 'text-gray-700');
                  btn.classList.add('bg-blue-500', 'text-white');
              } else {
                  btn.classList.remove('bg-blue-500', 'text-white');
                  btn.classList.add('bg-gray-200', 'text-gray-700');
              }
          });

          // æ›´æ–°æ—¶é—´èŒƒå›´æ˜¾ç¤º
          const timeRangeDisplay = document.getElementById('time-range-display');
          const rangeTexts = {
              'week': 'æœ€è¿‘ä¸€å‘¨',
              'month': 'æœ€è¿‘ä¸€æœˆ',
              'quarter': 'æœ€è¿‘ä¸‰æœˆ',
              'all': 'å…¨éƒ¨æ—¶é—´'
          };
          timeRangeDisplay.textContent = `æ—¶é—´èŒƒå›´: ${rangeTexts[range]}`;

          // é‡æ–°æ¸²æŸ“å›¾è¡¨
          renderCharts();
      }

      // æ ¹æ®æ—¶é—´èŒƒå›´ç­›é€‰æŠ¥å‘Š
      function filterReportsByTime(reports, range) {
          const now = new Date();
          let startDate;

          switch (range) {
              case 'week':
                  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  break;
              case 'month':
                  startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                  break;
              case 'quarter':
                  startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                  break;
              case 'all':
              default:
                  return reports;
          }

          return reports.filter(report => report.createdAt >= startDate);
      }

    // æˆ‘çš„ä¸¾æŠ¥é¡µé¢ç›¸å…³å˜é‡å’Œå‡½æ•°
    let currentFilter = 'pending'; // å½“å‰ç­›é€‰çŠ¶æ€

    function renderMyReportsView() {
        if (!currentUser) return;

        currentFilter = 'pending'; // é»˜è®¤æ˜¾ç¤ºå·²æäº¤/å¾…å¤„ç†

        if (currentUser.role === 'employee') {
            // æ™®é€šå‘˜å·¥ï¼šæ˜¾ç¤º"æˆ‘çš„ä¸¾æŠ¥"
            document.getElementById('my-page-title').textContent = 'æˆ‘çš„ä¸¾æŠ¥';
            document.getElementById('my-pending-label').textContent = 'å·²æäº¤';
            document.getElementById('manager-menu').classList.add('hidden');
            updateMyReportsStats();
            filterMyReports('pending');
        } else if (currentUser.role === 'manager') {
            // å®‰å…¨ç¯ä¿éƒ¨ï¼šæ˜¾ç¤º"å¤„ç†è®°å½•"
            document.getElementById('my-page-title').textContent = 'å¤„ç†è®°å½•';
            document.getElementById('my-pending-label').textContent = 'å¾…å¤„ç†';
            document.getElementById('manager-menu').classList.remove('hidden');
            updateMyReportsStats();
            filterMyReports('pending');
        }
    }

    function showSafetyKnowledgeManagement() {
        showSafetyKnowledge();
    }

    function loadUploadedDocuments() {
        const documentsList = document.getElementById('uploaded-documents-list');
        const documents = db.safetyDocuments || [];

        if (documents.length === 0) {
            documentsList.innerHTML = '<p class="text-sm text-gray-500 text-center">æš‚æ— ä¸Šä¼ çš„æ–‡æ¡£</p>';
            return;
        }

        documentsList.innerHTML = documents.map(doc => {
            const fileIcon = getFileIcon(doc.fileType);
            const fileSize = formatFileSize(doc.fileSize);
            const uploadDate = new Date(doc.uploadTime).toLocaleDateString();

            return `
                <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                    <div class="flex items-center space-x-2 flex-1 min-w-0">
                        <i class="${fileIcon} text-lg"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 truncate" title="${doc.title}">${doc.title}</p>
                            <p class="text-xs text-gray-500">${doc.fileName} â€¢ ${fileSize}</p>
                            <p class="text-xs text-gray-400">${uploadDate} â€¢ ${doc.uploadedBy}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="downloadSafetyDocument(${doc.id})" class="text-blue-500 hover:text-blue-700 p-1" title="ä¸‹è½½">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="deleteSafetyDocument(${doc.id})" class="text-red-500 hover:text-red-700 p-1" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function downloadSafetyDocument(docId) {
        const document = db.safetyDocuments.find(doc => doc.id === docId);
        if (document) {
            showNotification('ä¸‹è½½æ–‡æ¡£', `æ­£åœ¨ä¸‹è½½ï¼š${document.title}`, 'success');
            // è¿™é‡Œå¯ä»¥å®ç°å®é™…çš„ä¸‹è½½åŠŸèƒ½
        }
    }

    function deleteSafetyDocument(docId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) {
            const index = db.safetyDocuments.findIndex(doc => doc.id === docId);
            if (index !== -1) {
                const deletedDoc = db.safetyDocuments[index];
                db.safetyDocuments.splice(index, 1);
                loadUploadedDocuments(); // é‡æ–°åŠ è½½åˆ—è¡¨
                showNotification('åˆ é™¤æˆåŠŸ', `å·²åˆ é™¤æ–‡æ¡£ï¼š${deletedDoc.title}`, 'success');
            }
        }
    }

    function updateMyReportsStats() {
        if (!currentUser) return;

        let myReports;
        if (currentUser.role === 'employee') {
            // æ™®é€šå‘˜å·¥ï¼šåªæ˜¾ç¤ºè‡ªå·±çš„ä¸¾æŠ¥
            myReports = getFilteredReports().filter(r => r.reporterId === currentUser.role);
        } else if (currentUser.role === 'manager') {
            // å®‰å…¨ç¯ä¿éƒ¨ï¼šæ˜¾ç¤ºæ‰€æœ‰ä¸¾æŠ¥ï¼ˆå¤„ç†è®°å½•ï¼‰
            myReports = getFilteredReports();
        } else {
            return;
        }

        // å·²æäº¤/å¾…å¤„ç†ï¼šsubmittedçŠ¶æ€
        const pendingReports = myReports.filter(r => r.status === 'submitted');
        // å¤„ç†ä¸­ï¼špending_rectification
        const processingReports = myReports.filter(r => r.status === 'pending_rectification');
        // å·²åŠç»“ï¼šclosed
        const closedReports = myReports.filter(r => r.status === 'closed');

        document.getElementById('my-pending-count').textContent = pendingReports.length;
        document.getElementById('my-processing-count').textContent = processingReports.length;
        document.getElementById('my-closed-count').textContent = closedReports.length;
    }

    function filterMyReports(status) {
        currentFilter = status;

        // æ›´æ–°å¡ç‰‡æ ·å¼ï¼šé€‰ä¸­çš„å¡ç‰‡æ·»åŠ ç™½è‰²è¾¹æ¡†é«˜äº®
        const cards = document.querySelectorAll('.filter-card');
        cards.forEach(card => {
            card.classList.remove('border-white', 'shadow-xl', 'scale-105');
            card.classList.add('border-transparent');
        });

        const activeCardIndex = status === 'pending' ? 0 : status === 'processing' ? 1 : 2;
        cards[activeCardIndex].classList.remove('border-transparent');
        cards[activeCardIndex].classList.add('border-white', 'shadow-xl', 'scale-105');

        // ç­›é€‰å¹¶æ¸²æŸ“åˆ—è¡¨
        renderFilteredReports(status);
    }

    function renderFilteredReports(status) {
        const listEl = document.getElementById('my-reports-list');

        if (!currentUser) {
            listEl.innerHTML = '<p class="text-center text-gray-500">è¯·å…ˆç™»å½•</p>';
            return;
        }

        let myReports;
        if (currentUser.role === 'employee') {
            // æ™®é€šå‘˜å·¥ï¼šåªæ˜¾ç¤ºè‡ªå·±çš„ä¸¾æŠ¥
            myReports = getFilteredReports().filter(r => r.reporterId === currentUser.role);
        } else if (currentUser.role === 'manager') {
            // å®‰å…¨ç¯ä¿éƒ¨ï¼šæ˜¾ç¤ºæ‰€æœ‰ä¸¾æŠ¥
            myReports = getFilteredReports();
        } else {
            return;
        }

        let filteredReports = [];
        if (status === 'pending') {
            filteredReports = myReports.filter(r => r.status === 'submitted');
        } else if (status === 'processing') {
            filteredReports = myReports.filter(r => r.status === 'pending_rectification');
        } else if (status === 'closed') {
            filteredReports = myReports.filter(r => r.status === 'closed');
        }

        if (filteredReports.length === 0) {
            const emptyMessages = {
                'pending': currentUser.role === 'employee' ? 'æš‚æ— å·²æäº¤çš„ä¸¾æŠ¥' : 'æš‚æ— å¾…å¤„ç†çš„ä¸¾æŠ¥',
                'processing': 'æš‚æ— å¤„ç†ä¸­çš„ä¸¾æŠ¥',
                'closed': 'æš‚æ— å·²åŠç»“çš„ä¸¾æŠ¥'
            };
            listEl.innerHTML = `
                <div class="text-center py-12 bg-gray-50 rounded-xl">
                    <i class="fas fa-clipboard-list text-5xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">${emptyMessages[status]}</p>
                </div>
            `;
            return;
        }

        listEl.innerHTML = filteredReports.reverse().map(report => {
            const severityClass = report.severity === 'high' ? 'safety-level-high' :
                                report.severity === 'medium' ? 'safety-level-medium' : 'safety-level-low';

            return `
                <div class="bg-white rounded-xl p-4 border ${severityClass} card-hover cursor-pointer" onclick="showDetail(${report.id})">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 mr-3">
                            <div class="flex items-center mb-1">
                                ${getHazardTypeIcon(report.hazardType)}
                                <span class="text-xs text-gray-500 ml-2">ID: #${report.id}</span>
                            </div>
                            <p class="text-gray-800 line-clamp-2">${report.description}</p>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${report.location}</p>
                            ${currentUser.role === 'manager' ? `<p class="text-xs text-blue-600 mt-1"><i class="fas fa-user mr-1"></i>ä¸¾æŠ¥äºº: ${report.reporter}</p>` : ''}
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${getStatusBadge(report.status)}
                            ${getSeverityBadge(report.severity)}
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>${report.history[0].timestamp}</span>
                        ${currentUser.role === 'employee' && report.assignedTo ? `<span class="text-blue-600">å¤„ç†äºº: ${report.assignedTo}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- é€»è¾‘æ“ä½œ ---
    document.getElementById('report-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const description = document.getElementById('description').value;
        const location = document.getElementById('location').value;
        const hazardType = document.querySelector('input[name="hazard-type"]:checked').value;
        const severity = document.getElementById('severity-level').value;
        
        if (!description) {
            showNotification('æç¤º', 'è¯·å¡«å†™è¯¦ç»†æè¿°ï¼', 'warning');
            return;
        }
        
        if (!location) {
            showNotification('æç¤º', 'è¯·å¡«å†™å…·ä½“ä½ç½®ï¼', 'warning');
            return;
        }

        const newReport = {
            id: db.nextReportId++,
            reporter: currentUser.name,
            reporterId: currentUser.role,
            description: description,
            hazardType: hazardType,
            severity: severity,
            location: location,
            initialImages: [`https://placehold.co/600x400/${getRandomColor()}/ffffff?text=éšæ‚£ç…§ç‰‡`],
            status: 'submitted',
            assignedTo: null,
            assignedToId: null,
            plan: null,
            rectifiedImages: [],
            history: [
                { user: currentUser.name, action: 'æäº¤äº†éšæ‚£ä¸¾æŠ¥', timestamp: new Date().toLocaleString() }
            ],
            createdAt: new Date(),
            feedback: null,
            section: currentSection // æ·»åŠ æ ‡æ®µä¿¡æ¯
        };
        
        db.reports.push(newReport);
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('description').value = '';
        document.getElementById('location').value = '';
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showNotification('æäº¤æˆåŠŸ', 'æ‚¨çš„ä¸¾æŠ¥å·²æäº¤ï¼Œå®‰å…¨éƒ¨é—¨å°†å°½å¿«å¤„ç†', 'success');
        
        // å‘é€é€šçŸ¥ç»™å®‰å…¨ç»ç†
        if (severity === 'high') {
            addNotification('manager', 'ç´§æ€¥éšæ‚£', `æœ‰æ–°çš„é‡å¤§éšæ‚£ä¸¾æŠ¥éœ€è¦ç«‹å³å¤„ç†ï¼š${description}`, 'urgent');
        }

        // æ›´æ–°ä¸»è§†å›¾å’Œæˆ‘çš„ä¸¾æŠ¥ç»Ÿè®¡
        renderMainView();
        if (currentUser.role === 'employee') {
            updateMyReportsStats();
        }
        showView('main-view');
    });

    function getRandomColor() {
        const colors = ['fecaca', 'fde68a', 'dbeafe', 'dcfce7'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    
    function rejectReport(id) {
        const reason = prompt("è¯·è¾“å…¥é©³å›åŸå› :", "æ•´æ”¹ä¸å½»åº•ï¼Œè¯·é‡æ–°å¤„ç†ã€‚");
        if (reason) {
            const report = db.reports.find(r => r.id === id);
            report.status = 'pending_rectification';
            report.history.push({
                user: currentUser.name,
                action: 'é©³å›äº†æ•´æ”¹',
                content: `é©³å›åŸå› ï¼š${reason}`,
                timestamp: new Date().toLocaleString()
            });

            // é€šçŸ¥å·²é©³å›
            showNotification('å·²é©³å›', `é©³å›åŸå› ï¼š${reason}`, 'warning');

            showNotification('å·²é©³å›', 'æ•´æ”¹ä»»åŠ¡å·²é©³å›ï¼Œè¯·é‡æ–°å¤„ç†', 'info');
            showDetail(id);
        }
    }

    // æ–°å¢ï¼šæ¥å—å¹¶ç¡®è®¤ä»»åŠ¡ï¼ˆä¸éœ€è¦å¡«å†™æ–¹æ¡ˆï¼‰
    function acceptTask(id) {
        const report = db.reports.find(r => r.id === id);

        report.status = 'pending_rectification';
        report.assignedTo = currentUser.name;
        report.assignedToId = currentUser.role;
        report.history.push({
            user: currentUser.name,
            action: 'å·²ç¡®è®¤æ¥æ”¶ä»»åŠ¡',
            content: 'ä»»åŠ¡å·²ç¡®è®¤ï¼Œæ­£åœ¨å¤„ç†ä¸­',
            timestamp: new Date().toLocaleString()
        });

        showNotification('æ¥æ”¶æˆåŠŸ', 'ä»»åŠ¡å·²ç¡®è®¤æ¥æ”¶ï¼Œæ­£åœ¨å¤„ç†ä¸­', 'success');
        showDetail(id);
    }

    // æ–°å¢ï¼šä¸æ˜¯éšæ‚£ï¼Œç›´æ¥åŠç»“
    function closeAsNonHazard(id) {
        const reason = prompt("è¯·è¯´æ˜ä¸ºä»€ä¹ˆä¸æ˜¯å®‰å…¨éšæ‚£:", "ç»ç°åœºæ ¸æŸ¥ï¼Œæ­¤æƒ…å†µç¬¦åˆå®‰å…¨æ ‡å‡†ï¼Œä¸æ„æˆå®‰å…¨éšæ‚£ã€‚");
        if (reason) {
            const report = db.reports.find(r => r.id === id);
            report.status = 'closed';
            report.assignedTo = currentUser.name;
            report.assignedToId = currentUser.role;
            report.history.push({
                user: currentUser.name,
                action: 'ç¡®è®¤ä¸ºééšæ‚£ï¼Œç›´æ¥åŠç»“',
                content: reason,
                timestamp: new Date().toLocaleString()
            });

            // å‘é€é€šçŸ¥ç»™ä¸¾æŠ¥äºº
            addNotification(report.reporterId, 'ä¸¾æŠ¥å·²å¤„ç†', `æ‚¨ä¸¾æŠ¥çš„æƒ…å†µç»æ ¸æŸ¥ç¡®è®¤ä¸ºééšæ‚£ï¼Œæ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼`, 'info');

            showNotification('åŠç»“æˆåŠŸ', 'å·²ç¡®è®¤ä¸ºééšæ‚£å¹¶ç›´æ¥åŠç»“', 'success');
            showDetail(id);
        }
    }

    // æ–°å¢ï¼šæ˜¾ç¤ºæ•´æ”¹è¡¨å•
    function showRectificationForm(id) {
        const form = document.getElementById(`rectification-form-${id}`);
        form.classList.remove('hidden');
    }

    // æ–°å¢ï¼šå¤„ç†æ•´æ”¹åå›¾ç‰‡ä¸Šä¼ 
    let tempRectifiedImages = {};
    function handleRectifiedImages(event, id) {
        const files = event.target.files;
        const preview = document.getElementById(`image-preview-${id}`);

        if (!tempRectifiedImages[id]) {
            tempRectifiedImages[id] = [];
        }

        preview.innerHTML = '';

        for (let file of files) {
            const reader = new FileReader();
            reader.onload = function(e) {
                tempRectifiedImages[id].push(e.target.result);
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'rounded-lg w-full h-32 object-cover cursor-pointer hover:opacity-90 transition';
                img.onclick = () => viewImage(e.target.result);
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }

    // å…¨å±€å˜é‡å­˜å‚¨ä¸Šä¼ çš„æ–‡æ¡£
    let uploadedDocuments = [];

    function handleDocumentUpload(event) {
        const files = event.target.files;
        const preview = document.getElementById('document-preview');
        const maxFiles = 5;

        // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
        preview.innerHTML = '';
        uploadedDocuments = [];

        // æ£€æŸ¥æ–‡ä»¶æ•°é‡
        if (files.length > maxFiles) {
            showNotification('æ–‡ä»¶è¿‡å¤š', `æœ€å¤šåªèƒ½ä¸Šä¼ ${maxFiles}ä¸ªæ–‡ä»¶`, 'warning');
            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å° (æ¯ä¸ªæ–‡ä»¶æœ€å¤§10MB)
        const maxSize = 10 * 1024 * 1024; // 10MB
        for (let file of files) {
            if (file.size > maxSize) {
                showNotification('æ–‡ä»¶è¿‡å¤§', `æ–‡ä»¶ "${file.name}" è¶…è¿‡10MBé™åˆ¶`, 'warning');
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                preview.innerHTML = '';
                uploadedDocuments = [];
                return;
            }
        }

        // å¤„ç†æ¯ä¸ªæ–‡ä»¶
        for (let file of files) {
            const reader = new FileReader();

            reader.onload = function(e) {
                const documentData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: e.target.result
                };

                uploadedDocuments.push(documentData);

                // åˆ›å»ºæ–‡ä»¶é¢„è§ˆå…ƒç´ 
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-200';

                // æ–‡ä»¶å›¾æ ‡å’Œåç§°
                const fileIcon = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);

                fileItem.innerHTML = `
                    <div class="flex items-center space-x-2 flex-1">
                        <i class="${fileIcon} text-lg"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 truncate">${file.name}</p>
                            <p class="text-xs text-gray-500">${fileSize}</p>
                        </div>
                    </div>
                    <button onclick="removeDocument('${file.name}')" class="text-red-500 hover:text-red-700 p-1">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;

                preview.appendChild(fileItem);
            };

            reader.readAsDataURL(file);
        }

        if (files.length > 0) {
            showNotification('ä¸Šä¼ æˆåŠŸ', `å·²é€‰æ‹©${files.length}ä¸ªæ–‡ä»¶`, 'success');
        }
    }

    function getFileIcon(fileType) {
        if (fileType.includes('pdf')) return 'fas fa-file-pdf text-red-500';
        if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word text-blue-500';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel text-green-500';
        if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fas fa-file-powerpoint text-orange-500';
        if (fileType.includes('image')) return 'fas fa-file-image text-purple-500';
        if (fileType.includes('text')) return 'fas fa-file-alt text-gray-500';
        return 'fas fa-file text-gray-400';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeDocument(fileName) {
        // ä»æ•°ç»„ä¸­ç§»é™¤æ–‡ä»¶
        uploadedDocuments = uploadedDocuments.filter(doc => doc.name !== fileName);

        // é‡æ–°æ¸²æŸ“é¢„è§ˆ
        const preview = document.getElementById('document-preview');
        preview.innerHTML = '';

        uploadedDocuments.forEach(doc => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-200';

            const fileIcon = getFileIcon(doc.type);
            const fileSize = formatFileSize(doc.size);

            fileItem.innerHTML = `
                <div class="flex items-center space-x-2 flex-1">
                    <i class="${fileIcon} text-lg"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-700 truncate">${doc.name}</p>
                        <p class="text-xs text-gray-500">${fileSize}</p>
                    </div>
                </div>
                <button onclick="removeDocument('${doc.name}')" class="text-red-500 hover:text-red-700 p-1">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;

            preview.appendChild(fileItem);
        });

        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        document.getElementById('document-files').value = '';

        showNotification('æ–‡ä»¶å·²ç§»é™¤', `å·²ç§»é™¤æ–‡ä»¶ï¼š${fileName}`, 'info');
    }

    // æ–°å¢ï¼šæäº¤æ•´æ”¹ï¼ˆæ–¹æ¡ˆ+å›¾ç‰‡ï¼‰å¹¶ç›´æ¥åŠç»“
    function submitRectification(id) {
        const plan = document.getElementById(`plan-input-${id}`).value;
        const images = tempRectifiedImages[id] || [];

        if (!plan) {
            showNotification('æç¤º', 'è¯·å¡«å†™æ•´æ”¹æ–¹æ¡ˆ!', 'warning');
            return;
        }

        if (images.length === 0) {
            showNotification('æç¤º', 'è¯·ä¸Šä¼ æ•´æ”¹åç…§ç‰‡!', 'warning');
            return;
        }

        const report = db.reports.find(r => r.id === id);
        report.status = 'closed';
        report.plan = plan;
        report.rectifiedImages = [...images];
        report.assignedTo = currentUser.name;
        report.assignedToId = currentUser.role;
        report.history.push({
            user: currentUser.name,
            action: 'å®Œæˆæ•´æ”¹å¹¶åŠç»“',
            content: `æ•´æ”¹æ–¹æ¡ˆï¼š${plan}`,
            timestamp: new Date().toLocaleString()
        });

        // æ¸…ç†ä¸´æ—¶å›¾ç‰‡æ•°æ®
        delete tempRectifiedImages[id];

        // å‘é€é€šçŸ¥ç»™ä¸¾æŠ¥äºº
        addNotification(report.reporterId, 'éšæ‚£å·²è§£å†³', `æ‚¨ä¸¾æŠ¥çš„å®‰å…¨éšæ‚£å·²æˆåŠŸæ•´æ”¹å¹¶åŠç»“ï¼Œæ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼`, 'success');

        showNotification('åŠç»“æˆåŠŸ', `éšæ‚£ #${id} å·²æ•´æ”¹å®Œæˆå¹¶åŠç»“ï¼`, 'success');
        showDetail(id);
    }

    // é€šçŸ¥ç³»ç»Ÿ
    function showNotification(title, message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            warning: 'bg-yellow-500', 
            error: 'bg-red-500',
            info: 'bg-blue-500',
            urgent: 'bg-red-600'
        };
        
        const notification = document.createElement('div');
        notification.className = `notification-toast ${colors[type]} text-white p-4 rounded-lg shadow-lg max-w-sm`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'} mr-3"></i>
                <div>
                    <p class="font-semibold">${title}</p>
                    <p class="text-sm opacity-90">${message}</p>
                </div>
            </div>
        `;
        
        const container = document.getElementById('notification-container');
        container.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function addNotification(targetRole, title, message, type) {
        notifications.push({
            targetRole,
            title,
            message,
            type,
            timestamp: new Date(),
            read: false
        });
        updateNotificationBadge();
    }

    function updateNotificationBadge() {
        if (!currentUser) return;
        
        const unreadCount = notifications.filter(n => 
            n.targetRole === currentUser.role && !n.read
        ).length;
        
        const badge = document.getElementById('notification-badge');
        if (badge) {
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
    }

    function showNotifications() {
        showNotification('é€šçŸ¥ä¸­å¿ƒ', 'æš‚æ— æ–°é€šçŸ¥', 'info');
    }

    function emergencyReport() {
        if (confirm('ç¡®è®¤è¦æäº¤ç´§æ€¥éšæ‚£ä¸¾æŠ¥å—ï¼Ÿ')) {
            showNotification('ç´§æ€¥ä¸¾æŠ¥', 'ç´§æ€¥ä¸¾æŠ¥é€šé“å·²å¼€å¯ï¼Œè¯·ç«‹å³è”ç³»å®‰å…¨éƒ¨é—¨ï¼', 'urgent');
            showView('new-report-view');
        }
    }

    function viewImage(imageSrc) {
        showNotification('å›¾ç‰‡æŸ¥çœ‹', 'å›¾ç‰‡å…¨åŠŸèƒ½æŸ¥çœ‹æ­£åœ¨å¼€å‘ä¸­', 'info');
    }

    function viewDocument(fileName) {
        // æŸ¥æ‰¾æŠ¥å‘Šä¸­çš„æ–‡æ¡£
        const report = db.reports.find(r => r.documents && r.documents.some(doc => doc.name === fileName));
        if (report) {
            const document = report.documents.find(doc => doc.name === fileName);
            if (document) {
                // åœ¨æ–°çª—å£ä¸­æ‰“å¼€æ–‡æ¡£ï¼ˆå¯¹äºå›¾ç‰‡ï¼‰
                if (document.type.includes('image')) {
                    const newWindow = window.open();
                    newWindow.document.write(`<img src="${document.data}" style="max-width:100%; height:auto;">`);
                } else {
                    // å¯¹äºå…¶ä»–æ–‡ä»¶ç±»å‹ï¼Œæä¾›ä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = document.data;
                    link.download = document.name;
                    link.click();

                    showNotification('æ–‡æ¡£æŸ¥çœ‹', `æ­£åœ¨ä¸‹è½½æ–‡ä»¶ï¼š${fileName}`, 'success');
                }
            }
        }
    }

      function directToReport() {
        // ç›´æ¥ç™»å½•ä¸ºå‘˜å·¥
        currentUser = db.users['employee'];
        document.getElementById('header-title').innerText = `ç¬¬${currentSection}æ ‡æ®µ - ${currentUser.name}`;
        showNotification('æ¬¢è¿', `ç¬¬${currentSection}æ ‡æ®µ${currentUser.name}ï¼Œè¯·é˜…è¯»ä¸¾æŠ¥é¡»çŸ¥`, 'info');
        showReportNoticeWithCountdown();
        updateNotificationBadge();
    }

    function showReportNoticeWithCountdown() {
        const modal = document.getElementById('report-notice-modal');
        const confirmBtn = document.getElementById('confirm-report-btn');
        const countdownTimer = document.getElementById('countdown-timer');

        modal.classList.remove('hidden');

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        confirmBtn.disabled = true;
        confirmBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
        confirmBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');

        // å¼€å§‹å€’è®¡æ—¶
        let countdown = 5;
        confirmBtn.textContent = `è¯·é˜…è¯»å®Œæ¯• (${countdown}ç§’)`;
        countdownTimer.textContent = `è¯·åœ¨ä»”ç»†é˜…è¯»åå¼€å§‹ä¸¾æŠ¥ ${countdown}`;

        const countdownInterval = setInterval(() => {
            countdown--;
            confirmBtn.textContent = `è¯·é˜…è¯»å®Œæ¯• (${countdown}ç§’)`;
            countdownTimer.textContent = `è¯·åœ¨ä»”ç»†é˜…è¯»åå¼€å§‹ä¸¾æŠ¥ ${countdown}`;

            if (countdown <= 0) {
                clearInterval(countdownInterval);
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                confirmBtn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
                confirmBtn.textContent = 'æˆ‘å·²é˜…è¯»ï¼Œå¼€å§‹ä¸¾æŠ¥';
                countdownTimer.textContent = 'è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹ä¸¾æŠ¥';
            }
        }, 1000);

        // ä¿å­˜å€’è®¡æ—¶IDä»¥ä¾¿æ¸…é™¤
        window.currentCountdownInterval = countdownInterval;
    }

    function confirmReportAndProceed() {
        const modal = document.getElementById('report-notice-modal');
        modal.classList.add('hidden');

        // æ¸…é™¤å€’è®¡æ—¶
        if (window.currentCountdownInterval) {
            clearInterval(window.currentCountdownInterval);
        }

        showView('new-report-view');
    }

// --- å®‰å…¨çŸ¥è¯†å¼¹çª—åŠŸèƒ½ ---

    function showSafetyKnowledge() {
        const modal = document.getElementById('safety-knowledge-modal');
        modal.classList.remove('hidden');

        // å¦‚æœæ˜¯å®‰å…¨ç¯ä¿éƒ¨ç”¨æˆ·ï¼Œæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸå’Œæ–‡æ¡£ç®¡ç†åŒºåŸŸ
        const adminUploadArea = document.getElementById('admin-upload-area');
        const documentManagementArea = document.getElementById('document-management-area');

        if (currentUser && currentUser.role === 'manager') {
            adminUploadArea.classList.remove('hidden');
            documentManagementArea.classList.remove('hidden');
            loadUploadedDocuments(); // åŠ è½½å·²ä¸Šä¼ çš„æ–‡æ¡£åˆ—è¡¨
        } else {
            adminUploadArea.classList.add('hidden');
            documentManagementArea.classList.add('hidden');
        }

        // éšè—å†…å®¹æ˜¾ç¤ºåŒºåŸŸ
        document.getElementById('knowledge-content-area').classList.add('hidden');
    }

    function closeSafetyKnowledge() {
        const modal = document.getElementById('safety-knowledge-modal');
        modal.classList.add('hidden');
    }

    function showKnowledgeCategory(category) {
        const knowledgeContentArea = document.getElementById('knowledge-content-area');
        const knowledgeTitleDisplay = document.getElementById('knowledge-title-display');
        const knowledgeContentDisplay = document.getElementById('knowledge-content-display');

        const categoryNames = {
            'fire': 'æ¶ˆé˜²å®‰å…¨',
            'electric': 'ç”¨ç”µå®‰å…¨',
            'mechanical': 'è®¾å¤‡å®‰å…¨',
            'height': 'é«˜å¤„ä½œä¸š',
            'edge': 'ä¸´è¾¹é˜²æŠ¤',
            'environment': 'ç¯å¢ƒä¿æŠ¤',
            'ppe': 'ä¸ªäººé˜²æŠ¤è£…å¤‡',
            'other': 'å…¶ä»–å®‰å…¨'
        };

        const categoryData = db.safetyKnowledge.filter(item => item.category === category);

        knowledgeTitleDisplay.textContent = categoryNames[category];

        if (categoryData.length === 0) {
            knowledgeContentDisplay.innerHTML = '<p class="text-gray-500">è¯¥åˆ†ç±»æš‚æ— å®‰å…¨çŸ¥è¯†å†…å®¹ã€‚</p>';
        } else {
            knowledgeContentDisplay.innerHTML = categoryData.map(item => `
                <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <h4 class="font-semibold text-gray-800 mb-2">${item.title}</h4>
                    <p class="text-sm text-gray-700 whitespace-pre-line">${item.content}</p>
                    <p class="text-xs text-gray-500 mt-2">ä¸Šä¼ æ—¶é—´ï¼š${new Date(item.uploadTime).toLocaleString()}</p>
                </div>
            `).join('');
        }

        knowledgeContentArea.classList.remove('hidden');
    }

    function uploadKnowledge() {
        const title = document.getElementById('knowledge-title').value.trim();
        const content = document.getElementById('knowledge-content').value.trim();
        const fileInput = document.getElementById('knowledge-file');
        const file = fileInput.files[0];

        if (!title) {
            showNotification('æç¤º', 'è¯·è¾“å…¥èµ„æ–™æ ‡é¢˜ï¼', 'warning');
            return;
        }

        if (!content && !file) {
            showNotification('æç¤º', 'è¯·è¾“å…¥èµ„æ–™å†…å®¹æˆ–é€‰æ‹©æ–‡ä»¶ï¼', 'warning');
            return;
        }

        let hasContent = false;
        let hasFile = false;

        // å¦‚æœæœ‰å†…å®¹ï¼Œæ·»åŠ åˆ°çŸ¥è¯†åº“
        if (content) {
            const newKnowledge = {
                id: db.nextKnowledgeId++,
                category: 'other', // é»˜è®¤åˆ†ç±»ï¼Œå¯ä»¥åç»­æ‰©å±•è®©ç”¨æˆ·é€‰æ‹©
                title: title,
                content: content,
                uploadedBy: currentUser.name,
                uploadTime: new Date().toISOString(),
                fileType: 'text'
            };

            db.safetyKnowledge.push(newKnowledge);
            hasContent = true;
        }

        // å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ·»åŠ åˆ°æ–‡æ¡£åº“
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const newDocument = {
                    id: db.nextDocumentId++,
                    title: title,
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    fileData: e.target.result, // å­˜å‚¨æ–‡ä»¶æ•°æ®
                    uploadTime: new Date().toISOString(),
                    uploadedBy: currentUser.name
                };

                db.safetyDocuments.push(newDocument);
                hasFile = true;

                // å®Œæˆåé‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨
                loadUploadedDocuments();
            };
            reader.readAsDataURL(file);
        }

        // æ¸…ç©ºè¡¨å•
        document.getElementById('knowledge-title').value = '';
        document.getElementById('knowledge-content').value = '';
        fileInput.value = '';

        // æ ¹æ®ä¸Šä¼ å†…å®¹æ˜¾ç¤ºä¸åŒçš„æˆåŠŸæ¶ˆæ¯
        let message = 'ä¸Šä¼ æˆåŠŸï¼';
        if (content && file) {
            message = 'å®‰å…¨çŸ¥è¯†å’Œæ–‡æ¡£å·²æˆåŠŸä¸Šä¼ ï¼';
        } else if (content) {
            message = 'å®‰å…¨çŸ¥è¯†å·²æˆåŠŸæ·»åŠ åˆ°çŸ¥è¯†åº“ï¼';
        } else if (file) {
            message = 'å®‰å…¨æ–‡æ¡£å·²æˆåŠŸä¸Šä¼ ï¼';
        }

        showNotification('ä¸Šä¼ æˆåŠŸ', message, 'success');

        // å¦‚æœåªä¸Šä¼ äº†å†…å®¹ï¼ˆæ²¡æœ‰æ–‡ä»¶ï¼‰ï¼Œç«‹å³é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨ä»¥é˜²æœ‰å˜åŒ–
        if (!file) {
            setTimeout(() => loadUploadedDocuments(), 100);
        }
    }

    // --- åˆå§‹åŒ– ---
    showView('login-view');

</script>
</body>
</html>
